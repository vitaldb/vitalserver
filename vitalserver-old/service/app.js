const express=require("express"),bodyParser=require("body-parser"),cors=require("cors"),fs=require("fs"),path=require("path"),request=require("request"),busboy=require("busboy"),soStream=require("socket.io-stream"),zlib=require("zlib"),cluster=require("cluster"),soRedis=require("socket.io-redis"),redis=require("async-redis"),redisSession=require("redis"),expressSession=require("express-session"),redisStore=require("connect-redis")(expressSession),app=express();var http=require("http").Server(app),io=require("socket.io")(http);io.adapter(soRedis({host:"0.0.0.0",port:6379}));const client=redis.createClient(6379,"0.0.0.0"),clientSession=redisSession.createClient(6379,"0.0.0.0");function get_websocket_port(){return new Promise(function(e,s){e(db.get_websocket_port())})}const vr_release=__dirname+"/vr_release/",config=require("./include/config.js"),monitor=require("./include/monitor.js"),db=require("./include/db.js");var file_folder=config.get_file_folder(),vrs_ipaddr={};function generateSortFn(r){return function(e,s){for(var t=0;t<r.length;t++){var i=r[t],n=i.name,i=i.reverse,n=e[n].localeCompare(s[n],void 0,{numeric:!0,sensitivity:"base"});if(n<0)return i?1:-1;if(0<n)return i?-1:1}return 0}}async function render_monitoring(e,s){var t=await db.get_share_info(e.session.userInfo.id,[1,4]),i=t.rooms;i.sort(generateSortFn([{name:"group"},{name:"bedname"}]));var n=t.groups,t=+Math.ceil(new Date/1e3);const r=new Object;r.body_id="web-monitoring",r.title="Web Monitoring",r.monitor_menu="active",r.user=e.session.userInfo,r.rooms=i,r.groups=n,r.now=t,r.vr_cnt=await db.get_bed_cnt(e.session.userInfo.id),r.vr_version=await client.get("vr_version"),r.websocket_host=await db.get_websocket_host(),r.devices=JSON.parse(fs.readFileSync(__dirname+"/static/devices.json")),r.filters=await db.get_filter_list(),s.render("monitoring",r)}function get_hl7_list(){return new Promise(function(e,s){e(monitor.get_hl7_list())})}async function send_bcnt(){var e=await db.get_bed_cnt();console.log("sending "+config.hospcode+" vr count ("+e+") to cloud server..."),request.post({headers:{"content-type":"application/json"},url:"https://vitaldb.net/recv_bcnt.php",body:{hosp:config.hospcode,bcnt:e},json:!0},function(e,s,t){console.log(e)})}var numCPUs=require("os").cpus().length-6;if(cluster.schedulingPolicy=cluster.SCHED_RR,cluster.isMaster){send_bcnt(),setInterval(send_bcnt,864e5);for(var i=0;i<numCPUs;i++)cluster.fork();cluster.on("fork",function(e){console.log("worker:"+e.id+" is forked")}),cluster.on("online",function(e){console.log("worker:"+e.id+" is online")}),cluster.on("listening",function(e){console.log("worker:"+e.id+" is listening")}),cluster.on("disconnect",function(e){console.log("worker:"+e.id+" is disconnected")}),cluster.on("exit",function(e,s,t){console.log("worker exit : id:"+e.process.pid+" code: "+s+" "+t),200!=s&&1!=s||(console.log("fork for code: "+s),cluster.fork())});var existsPath=fs.existsSync(file_folder);existsPath||fs.mkdirSync(file_folder),clientSession.exists("websocket:ip",function(e,s){if(1!=s){clientSession.set("websocket:ip","127.0.0.1"),clientSession.set("websocket:port","80");s=new Object;s.id="admin",s.password="admin",s.name="관리자",s.email="",s.admin_yn="Y",clientSession.sadd("users",s.id),clientSession.set("users:admin",JSON.stringify(s));var t,i=[{vr:"PVI",emr:"PVI"},{vr:"SPHB",emr:"SpHb"},{vr:"PSI",emr:"PSi"},{vr:"ORI",emr:"ORi"},{vr:"SO2_1",emr:"rSO_1"},{vr:"SO2_2",emr:"rSO_2"},{vr:"SO2_3",emr:"rSO_3"},{vr:"SO2_4",emr:"rSO_4"}];for(t in i)client.sadd("hl7",JSON.stringify(i[t]))}})}else{var server,session=expressSession({secret:"my key",resave:!1,saveUninitialized:!1,store:new redisStore({client:clientSession,ttl:1800}),cookie:{maxAge:26784e5}});function unlink_tmp_files(s){var t=path.join(__dirname,"/tmp_files/");console.log("deleting "+s+" tmp file(s)."),fs.readdirSync(t).forEach(async function(e){-1<e.indexOf(s)&&(console.log(e),fs.unlinkSync(path.join(t,e)))})}io.on("connection",function(l){function d(e){e=new Date(e);return e.getFullYear()+"-"+s(e.getMonth()+1)+"-"+s(e.getDate())+" "+s(e.getHours())+":"+s(e.getMinutes())+":"+s(e.getSeconds())}function s(e){return e=e<10?"0"+e:e}l.on("disconnect",function(){}),l.on("send_data",e=>{monitor.send_data(io,e)}),l.on("join_vr",s=>{io.to(l.id).emit("dt",Math.floor((new Date).getTime()/1e3)),l.join(s,async()=>{var e=l.handshake.address;e=(e=e.split(":"))[e.length-1],await client.set("ip_"+s,e)})}),l.on("join_bed",(s,t)=>{l.join(s,async()=>{var e=await client.get("ip_"+t);io.to(l.id).emit("recv_vr_ipaddr",s,e)})}),l.on("leave_bed",e=>{l.leave(e,()=>{})}),l.on("send_vrconf",async e=>{var s=await client.get("vrconf_"+e);io.to(l.id).emit("recv_vrconf",e,s)}),l.on("req_folder_list",e=>{var s=new Object,t=new Array,i=new Array,n=file_folder+e+"/";if(fs.existsSync(n))fs.readdirSync(n).forEach(function(e){var s=path.join(n,e),s=fs.statSync(s);s.isFile()?i.push(JSON.parse('{"filename":"'+e+'", "filesize":'+s.size+', "mtime":"'+d(s.mtime)+'"}')):s.isDirectory()&&t.push(e)}),s.files=i,s.folders=t,io.to(l.id).emit("res_folder_list",s,"folder");else{var r,o=JSON.parse(fs.readFileSync(__dirname+"/include/group.json"),"utf-8");for(r in o)if(e==o[r].name)for(var a in o[r].beds){var c,n=file_folder+o[r].beds[a]+"/";(existsPath=fs.existsSync(n))&&((c=fs.statSync(n)).isFile()?i.push(JSON.parse('{"filename":"'+name+'", "filesize":'+c.size+', "mtime":"'+d(c.mtime)+'"}')):c.isDirectory()&&t.push(o[r].beds[a]))}s.files=i,s.folders=t,io.to(l.id).emit("res_folder_list",s,"group")}}),l.on("req_vr_exe_list",()=>{var t=new Array;fs.existsSync(__dirname+"/vr_release/")&&(fs.readdirSync(file_path).forEach(function(e){var s=path.join(file_path,e),s=fs.statSync(s);s.isFile()&&t.push(JSON.parse('{"filename":"'+e+'", "filesize":'+s.size+', "mtime":"'+d(s.mtime)+'"}'))}),io.to(l.id).emit("res_vr_exe_list",t))}),l.on("req_json",async()=>{var e=JSON.parse(fs.readFileSync(__dirname+"/static/devices.json")),s=await db.get_filter_list();io.to(l.id).emit("res_json",e,s)}),l.on("req_bed_status",e=>{monitor.req_bed_status(io,l.id,e)}),l.on("req_prev_data",(e,s)=>{monitor.req_prev_data(io,l.id,e,s)}),l.on("req_cmd",e=>{monitor.req_cmd(io,l.id,e)}),l.on("send_vr_ipaddr",e=>{io.to(l.id).emit("recv_vr_ipaddr",vrs_ipaddr[e])}),l.on("send_vrs_ipaddr",()=>{io.to(l.id).emit("recv_vrs_ipaddr",JSON.stringify(vrs_ipaddr))}),l.on("req_manage_config",e=>{io.to(l.id).emit("res_manage_config",db.set_config(e))}),l.on("req_manage_user",async function(e,s){io.to(l.id).emit("res_manage",await db.set_user(e,s))}),l.on("req_manage_hl7",async function(e,s){io.to(l.id).emit("res_manage",await db.set_hl7(e,s))}),l.on("req_manage_account",async function(e){io.to(l.id).emit("res_manage_account",await db.set_user(e,"upd"))}),l.on("req_change_password",async function(e){io.to(l.id).emit("res_change_password",await db.set_password(e))}),l.on("upgrade_all_vr",function(){monitor.upgrade_all_vr(io)}),soStream(l).on("req_upload_vr",function(e,s){e.pipe(fs.createWriteStream(__dirname+"/vr_release/"+s.filename)),e.on("end",async function(){io.to(l.id).emit("res_manage",await db.set_vr(s,"add"))})})}),app.set("view engine","pug"),app.set("views",path.join(__dirname,"views")),app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.use(cors()),app.use("/static",express.static(path.join(__dirname,"static"))),app.use("/vital_files",express.static(file_folder)),app.use(session),app.get("/",function(e,s){e.session.login?render_monitoring(e,s):(e.session.nextpage="/",s.redirect("/check"))}),app.get("/web-monitoring",function(e,s){e.session.login?render_monitoring(e,s):(e.session.nextpage="/",s.redirect("/check"))}),app.post("/trd_noti",async function(e,s){var t=e.body.bedid,i=3600*e.body.range,n=Math.floor((new Date).getTime()/1e3),e="dts_trend_result_"+t,r=await client.zrangebyscore(e,"("+(n-i),"+inf"),o=[];for(c in r){var a="trend_"+t+"_"+r[c];o.push(a)}if(s.write("{"),0<o.length){var c,l=await client.mget(o);for(c in l)0<c&&s.write(","),s.write('"'+r[c]+'":'+l[c])}s.end("}")}),app.post("/api/login",async function(e,s){if(!(e.body.id&&e.body.pw||e.query.id&&e.query.pw))return s.status(400).json({message:"Invalid input"});var t=e.body.id||e.query.id,e=e.body.pw||e.query.pw,e=await db.api_login(t,e);e.res?s.json(e):s.status(400).json({message:e.error})}),app.get("/api/filelist",async function(e,s){if(!e.query.access_token)return s.status(400).json({message:"Invalid input"});e.setTimeout(12e5);var t=await db.check_access_token(e.query.access_token);if(t){s.header("Content-Type","application/x-gzip"),s.attachment("filelist_"+Math.floor(Date.now()/1e3)+".gz");var i=zlib.createGzip();i._flush=zlib.constants.Z_SYNC_FLUSH,i.pipe(s);var n,r,o,a=e.query.bedname||null,c=e.query.dtstart||null,l=e.query.dtend||null,d=e.query.dtuploadstart||null,u=e.query.dtuploadend||null,p=await db.get_bednames(t,[2,4]),f=[],_=[],g=[];for(b in o=d||u?(d?(n=new Date(d),isNaN(n)||(d=Math.floor(n.getTime()/1e3))):d=0,u?(r=new Date(u),isNaN(r)||(u=Math.floor(r.getTime()/1e3))):u="+inf",await client.zrangebyscore("api:filelist:dtupload",d,u)):(c?(c.length<=10&&(c+=" 00:00:00"),n=new Date(c),isNaN(n)||(c=Math.floor(n.getTime()/1e3)-60)):c=0,l?(l.length<=10&&(l+=" 00:00:00"),r=new Date(l),isNaN(r)||(l=Math.floor(r.getTime()/1e3)+60)):l="+inf",await client.zrangebyscore("api:filelist:dtstart",c,l))){var m=(x=o[b]).slice(0,-14);if(p.includes(m)){if(a){var v=!1;for(k in a="string"==typeof a?a.split(","):a)-1<x.indexOf(a[k].trim())&&(v=!0);if(!v)continue}f.push("api:filelist:fileinfo:"+x),_.push("hid1:"+x),g.push("hid2:"+x)}}if(0<f.length){var h=f.length;i.write("[");for(var b=0;b<Math.ceil(h/5e5);b++){var w,y,k,S=[],q=await client.mget(f.slice(5e5*b,5e5*(b+1)));for(k in"1"==e.query.hid&&(w=await client.mget(_.slice(5e5*b,5e5*(b+1))),y=await client.mget(g.slice(5e5*b,5e5*(b+1)))),q){var x,j='{"filename":"'+(x=f[5e5*b+ +k].split(":").pop())+'.vital",';"1"==e.query.notimestamp?j+=q[k].slice(q[k].indexOf("filesize")-1):(e.query.unixtimestamp&&"1"==e.query.unixtimestamp||(q[k]=JSON.parse(q[k]),q[k].dtstart=db.ut2d(q[k].dtstart),q[k].dtend=db.ut2d(q[k].dtend),q[k].dtupload=db.ut2d(q[k].dtupload),q[k]=JSON.stringify(q[k])),"1"==e.query.hid&&(j+='"hid1":"'+(w[k]||"")+'","hid2":"'+(y[k]||"")+'",'),j+=q[k].slice(1)),S.push(j)}0<b&&i.write(","),i.write(S.join(","))}i.write("]"),i.end()}else s.status(404).json({message:"No result found"})}else s.status(400).json({message:"Invalid access token"})}),app.get("/api/tracklist",async function(e,t){if(console.log(e.query),!e.query.access_token)return t.status(400).json({message:"Invalid input"});var s=await db.api_tracklist(e.query);s.res?(e=Buffer.from(JSON.stringify(s.data),"utf8"),zlib.gzip(e,function(e,s){t.header("Content-Type","application/x-gzip"),t.attachment("tracklist_"+Math.floor(Date.now()/1e3)+".gz"),t.send(s)})):t.status(400).json({message:s.error})}),app.get("/api/download",async function(e,s){if(!e.query.access_token)return s.status(400).json({message:"Invalid input"});var t,i,n=e.query.access_token;await db.check_access_token(n)?(t=(i=e.query.filename).substr(0,i.length-20),n=i.substr(i.length-19,6),e=((new Date).getFullYear()+"").substr(0,2)+n.substr(0,4),i=path.join(file_folder,t,e,n,i),fs.existsSync(i)?s.download(i):s.status(404).json({message:"File not found"})):s.status(401).json({message:"Access token expired"})}),app.post("/adt",async function(e,s){var t,i,n,r=e.body.filename.trim(),o=e.body.hid.trim();0<r.length&&0<o.length&&(t=r.slice(0,-14),i=((new Date).getFullYear()+"").slice(0,2)+r.slice(-13,-11),n=r.slice(-11,-9),e=r.slice(-9,-7),await client.sadd("adt:"+i+":"+n+":"+e,r),(e=await client.get("hid1:"+r))?e!=o&&await client.set("hid2:"+r,o):await client.set("hid1:"+r,o),await client.set("hid:"+t,o,"EX",300))}),app.get("/adt/:yyyy?/:mm?/:dd?",async function(e,s){var t=e.params.yyyy||null,i=e.params.mm||null,n=e.params.dd||null;if(e.query.access_token&&(r=await db.check_access_token(e.query.access_token)),e.session.login||r){var r="adt",o="adt";t&&(r+=":"+t,o+="_"+t),i&&(r+=":"+i,o+="_"+i),n&&(r+=":"+n,o+="_"+n);var a=await client.keys(r+"*"),c=[],l=[],d=[],u=await db.get_bednames(e.session.userInfo.id,[2,4]);for(m in a){var p=await client.smembers(a[m]);for(v in p){var f=p[v],_=f.slice(0,-14);u.indexOf(_)<0||(c.push(f),l.push("hid1:"+f),d.push("hid2:"+f))}}if(0<c.length)for(var g="hid1,hid2,filename\n",m=0;m<Math.ceil(c.length/5e5);m++){var v,h=await client.mget(l.slice(5e5*m,5e5*(m+1))),b=await client.mget(d.slice(5e5*m,5e5*(m+1)));for(v in h)h[v]||(h[v]=""),b[v]||(b[v]=""),g+=h[v]+","+b[v]+","+c[5e5*m+ +v]+"\n"}return s.header("Content-Type","text/csv"),s.attachment(o+".csv"),s.send(g)}o="/adt";t&&(o+="/"+t),i&&(o+="/"+i),n&&(o+="/"+n),e.session.nextpage=o,s.redirect("/check")}),app.post("/vr_devs",async function(e,s){e=(e=await client.get("devs_"+e.body.bedid))||{};s.send(e)}),app.post("/vr_filts",async function(e,s){e=(e=await client.get("filts_"+e.body.bedid))||{};s.send(e)}),app.get("/refresh_session",function(e,s){e.session.cookie.expires=new Date(Date.now()+36e5),s.send()}),app.get("/webview",async function(e,s){const t=new Object;var i,n,r,o;e.query.filename&&(n=(i=e.query.filename).substr(0,i.length-20),r=i.substr(i.length-19,6),o=((new Date).getFullYear()+"").substr(0,2)+r.substr(0,4),e.query.path="/"+n+"/"+o+"/"+r+"/"+i,t.path="http://"+await db.get_websocket_host()+"/vital_files/"+e.query.path,t.filename=i,s.render("webview",t))}),app.get("/webview2",async function(e,s){s.render("webview2")}),app.get("/getvr.php",async function(e,s){var t=await client.get("vr_version"),t=vr_release+"setup."+t;if(console.log("Upgrading VR with "+t+".msi"),fs.existsSync(t+".exe"))s.download(t+".exe");else if(fs.existsSync(t+".msi"))s.download(t+".msi");else{var i,n=[],r=fs.readdirSync(vr_release);for(i in r){var o,a=r[i];".exe"!=a.substr(-4)&&".msi"!=a.substr(-4)||((o={}).name=a,o.vrver=a.split("."),o.vrver=parseInt(o.vrver.slice(1,o.vrver.length-1).join("").padEnd(10,"0")),isNaN(o.vrver)&&(o.vrver=0),n.push(o))}0<n.length&&(t=n.reduce(function(e,s){return e.vrver<s.vrver?s:e}),s.download(vr_release+t.name))}}),app.get("/pivr",async function(e,s){var t=await client.get("vr_version"),i=vr_release+"pivr_"+t;if(fs.existsSync(i))console.log("Upgrading VR with "+i),s.download(i,"pivr");else{var n,r=[],o=fs.readdirSync(vr_release);for(n in o){var a=o[n];"pivr"==a.substr(0,4)&&((i={}).name=a,i.ver=a.split("_"),1<i.ver.length&&(i.ver=i.ver[1].replace(/\./g,"")),isNaN(i.ver)&&(i.ver="0"),r.push(i))}0<r.length&&(t=r.reduce(function(e,s){return e.ver.padEnd(10,"0")<s.ver.padEnd(10,"0")?s:e}),console.log("Upgrading VR with "+vr_release+t.name),s.download(vr_release+t.name,"pivr"))}}),app.get("/download-vr/:prevurl?",function(e,s){var t=request("https://vitaldb.net/getvr.php?type=pivr"),i=/filename=\"(.*)\"/gi;t.on("response",async function(e){var s=i.exec(e.headers["content-disposition"])[1];e.pipe(fs.createWriteStream(__dirname+"/vr_release/"+s)),pivr_ver=s.split("_"),1<pivr_ver.length&&(pivr_ver=pivr_ver[1]),await client.set("vr_version",pivr_ver)}).on("end",function(){s.redirect("/"+(e.params.prevurl||""))})}),app.get("/icu",async function(e,s){if(e.session.login){const t=new Object;t.body_id="icu",t.title="ICU Dashboard",t.user=e.session.userInfo,t.unit="PICU",t.date="2023-02-01",t.icu_files=await db.icu_filelist("PICU","2023-02-01"),s.render("icu",t)}else e.session.nextpage="/icu",s.redirect("/check")}),app.get("/my-files",async function(e,s){if(e.session.login){const t=new Object;t.body_id="my-files",t.title="My Files",t.file_menu="active",t.user=e.session.userInfo,t.bednames=await db.get_bednames(e.session.userInfo.id,[2,4]),s.render("my-files",t)}else e.session.nextpage="/my-files",s.redirect("/check")}),app.get("/my-files/stats",function(e,s){if(e.session.login){const t=new Object;t.body_id="my-files",t.title="File Stats",t.file_menu="active",t.user=e.session.userInfo,s.render("my-files-stats",t)}else e.session.nextpage="/my-files/stats",s.redirect("/check")}),app.get("/my-files/download",function(e,s){var t=e.query.filename,i=t.substr(0,t.length-20),n=t.substr(t.length-19,6),e=((new Date).getFullYear()+"").substr(0,2)+n.substr(0,4),n=path.join(file_folder,i,e,n,t);console.log(t),fs.existsSync(n)?s.download(n):s.status(404).json({message:"File not found"})}),app.post("/my-files/data.php",async function(e,s){var t;e.session.login?(t=await db.get_files(e),s.json(t)):(e.session.nextpage="/my-files",s.redirect("/check"))}),app.get("/manage-config",async function(e,s){if(e.session.login){const t=new Object;t.body_id="manage-config",t.title="manage-config",t.config_menu="active",t.user=e.session.userInfo,t.config=await db.get_config(),t.websocket_host=await db.get_websocket_host(),s.render("manage-config",t)}else e.session.nextpage="/manage-config",s.redirect("/check")}),app.get("/manage-user",async function(e,s){if(e.session.login){const t=new Object;t.body_id="manage-user",t.title="manage-user",t.config_menu="active",t.user=e.session.userInfo,t.users=await db.get_user_list(),t.websocket_host=await db.get_websocket_host(),"Y"==e.session.userInfo.admin_yn?s.render("manage-user",t):s.redirect("/")}else e.session.nextpage="/manage-user",s.redirect("/check")}),app.get("/manage-hl7",async function(e,s){if(e.session.login){const t=new Object;t.body_id="manage-hl7",t.title="manage-hl7",t.config_menu="active",t.user=e.session.userInfo,t.obxs=(await client.smembers("hl7")).sort(),t.hl7_host=await db.get_hl7_host(),t.hl7_port=await db.get_hl7_port(),t.websocket_host=await db.get_websocket_host(),"Y"==e.session.userInfo.admin_yn?s.render("manage-hl7",t):s.redirect("/")}else e.session.nextpage="/manage-hl7",s.redirect("/check")}),app.get("/manage-account",async function(e,s){if(e.session.login){e.session.userInfo=JSON.parse(await client.get("users:"+e.session.userInfo.id));const t=new Object;t.body_id="manage-account",t.title="manage-account",t.account_menu="active",t.user=e.session.userInfo,t.websocket_host=await db.get_websocket_host(),s.render("manage-account",t)}else e.session.nextpage="/manage-account",s.redirect("/check")}),app.post(["/upload_vital.php","/upload"],function(e,a){const s=busboy({headers:e.headers});s.on("file",(e,s,t,i,n)=>{console.log(cluster.worker.process.pid+" : "+t+" uploaded from Vital Recorder");var r=path.join(__dirname,"/tmp_files/",t+"."+Math.floor(Date.now()/1e3)+".tmp");const o=fs.createWriteStream(r);s.pipe(o),o.on("close",async()=>{var e=await monitor.upload_vital(t,r,file_folder);unlink_tmp_files(t),console.log(e+" : tmp file(s) deleted"),a.send(e)})}),e.pipe(s)}),app.post("/set-config",function(e,s){e=db.set_config(e.body);s.send(e)}),app.post("/my-vr/data.php",async function(e,s){e=await db.get_data(e);s.send(e)}),app.route("/check").get(async function(e,s,t){if(e.session.login){var i=e.session.nextpage;null==i||null==i?s.redirect("/"):s.redirect(i)}else{i="";null==e.session.login||e.session.login||(i="show");const n=new Object;n.body_id="Home",n.title="Home",n.show=i,n.user=new Object,n.websocket_host=await db.get_websocket_host(),s.render("check",n)}}).post(async function(e,s){var t=await db.login(e.body.mb_id,e.body.mb_password);e.session.login=t.result,t.result?(e.session.userInfo=t,null==(t=e.session.nextpage)||null==t?s.redirect("/"):(e.session.nextpage=null,s.redirect(t))):s.redirect("/check")}),app.get("/logout",function(e,s){e.session.destroy(),s.redirect("/check")}),app.route("/HL7").get(function(e,s){get_hl7_list().then(function(e){s.send(e)})}).post(function(e,s){get_hl7_list().then(function(e){s.send(e)})}),get_websocket_port().then(function(e){server=http.listen(e,function(){global.__basedir=__dirname,monitor.set_filter_list(),console.log("http load Success! work process pid : "+cluster.worker.process.pid)})})}