var devices,filters,curr_devs,mv_apiRoot="/my-vr",viewers=[],selected_beds2=new Set,selected_bedids2=new Set,curr_order="bedname",curr_group="all",select_all2=!0,get_vrs_job="get_myvrs",orders={bedname:"SORT_ASC",group:"SORT_DESC"};function timeConverter(e){if(0==e)return"long time ago";var t=new Date(1e3*e),d=t.getFullYear(),o=t.getMonth()+1,s=t.getDate(),a=t.getHours(),e=t.getMinutes(),t=t.getSeconds(),s=d+"-"+(1==o.toString().length?"0"+o:o)+"-"+(1==s.toString().length?"0"+s:s)+" ";return s+=(1==a.toString().length?"0"+a:a)+":"+(1==e.toString().length?"0"+e:e)+":"+(1==t.toString().length?"0"+t:t)}function show_sort(e){var t=$("#sort_"+e);"SORT_ASC"==orders[e]?$(t).removeClass("fa-sort").addClass("fa-sort-up"):$(t).removeClass("fa-sort").addClass("fa-sort-down")}function hide_sort(e){$("#"+e).removeClass("fa-sort-up").removeClass("fa-sort-down").addClass("fa-sort")}function openTab(){$("#group-filter-side-tab").removeClass("show-tab"),document.getElementById("group-filter-side-tab").style.width="0",edit_vrs(curr_order),document.getElementById("add-vr-side-tab").style.width="410px",$("#add-vr-side-tab").addClass("show-tab"),document.getElementById("web-monitoring").style.marginLeft="410px",wm_onResizeWindow()}function closeTab(){location.reload()}function openGFTab(){$("#add-vr-side-tab").removeClass("show-tab"),document.getElementById("add-vr-side-tab").style.width="0",setTimeout(function(){document.getElementById("group-filter-side-tab").style.width="200px",$("#group-filter-side-tab").addClass("show-tab"),document.getElementById("web-monitoring").style.marginLeft="200px",wm_onResizeWindow(),$("#filter-bed").focus()})}function closeGFTab(){document.getElementById("group-filter-side-tab").style.width="0",$("#group-filter-side-tab").removeClass("show-tab"),document.getElementById("web-monitoring").style.marginLeft="0",setTimeout(wm_resizeRoomWidth,500)}function toggle_viewers(){$(".info").hasClass("d-none")?($(".info").removeClass("d-none").css("display","table-row"),$("#toggle-info").removeClass("btn-light").addClass("btn-primary")):($(".info").addClass("d-none"),$("#toggle-info").removeClass("btn-primary").addClass("btn-light")),filter_group(curr_group)}function edit_vrs(m="bedname",u=null,b=!1){event.preventDefault(),$.ajax({url:mv_apiRoot+"/data.php",type:"POST",dataType:"json",responseType:"text",data:{job:get_vrs_job,order:m,sort:null==u?orders[m]:u},success:function(e){var t=!1,d="<option value='all' selected>All</option>",o="<option value='all' selected>Group</option>";for(r in e.groups){var s=e.groups[r];d+="<option value='"+s+"'>"+s+"</option>",o+="<option value='"+s+"'>"+s+"</option>"}d+="<option value='Unspecified'>Unspecified</option>",d+="<option value='other'>Add group</option>",o+="<option value='Unspecified'>Unspecified</option>",o+="<option value='Unnamed'>Unnamed</option>",$("#groupname").html(d),$("#groupfilter").html(o);var a,n=Cookies.get("WebMonitoring_expanded")?" dark":"",i="";if("get_sharedvrs"==get_vrs_job)for(var r in console.log(e.vrs),e.vrs)""==(a=e.vrs[r]).group&&(t=!0),i+="<tr id='"+a.bedname+"' bedname='"+a.bedname+"' bedid='"+a.bedid+"' class='bed "+a.bedid+" "+(""==a.group?"Unspecified":a.group)+n+"'>",i+="<td style='text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' title='"+a.bedname+"'>",i+="<div class='custom-control custom-checkbox' style='margin-top: -1px;'>",i+="<input type='checkbox' class='custom-control-input' id='sel-"+a.bedid+"' onchange='select_bed2(\""+a.bedname+'","'+a.bedid+"\")'>",i+="<label class='custom-control-label' for='sel-"+a.bedid+"'></label>",i+="</div>"+a.bedname+"</td>",i+="<td></td>",i+="<td style='text-align:right;'>",i+=(a.islinux?"Linux":wm_rooms[a.bedid].is_offline?"":"Windows")+"&nbsp;&nbsp;&nbsp;",i+="<a class='text-secondary pr-2' onclick='del_bed(\""+a.bedid+'","'+a.bedname+"\")' title='Delete bed'><i class='far fa-trash-alt' style='width:10.5px'></i></a>",i+="</td></tr>";else for(var r in e.vrs){null==(a=e.vrs[r]).group&&(t=!(a.group="")),i+="<tr id='"+a.bedname+"' bedname='"+a.bedname+"' bedid='"+a.bedid+"' class='bed bed-"+a.vrcode+" "+a.bedid+" "+(""==a.group?"Unspecified":a.group.replace(/\s/g,""))+n+"'>",i+="<td style='text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' title='"+a.bedname+"'><div class='custom-control custom-checkbox' style='margin-top: -1px;'><input type='checkbox' class='custom-control-input' id='sel-"+a.bedid+"' onchange='select_bed2(\""+a.bedname+'","'+a.bedid+"\")'><label class='custom-control-label' for='sel-"+a.bedid+"'></label></div>"+a.bedname+"</td>",i+="<td title='uploaded "+a.utime+"'>"+a.vrcode+"<a class='text-secondary pl-1' onclick='copy_to_clipboard(\""+a.vrcode+"\")'><i class='far fa-copy'></i></a></td>",i+="<td style='text-align:right;'>",i+=(a.islinux?"Linux":wm_rooms[a.bedid].is_offline?"":"Windows")+"&nbsp;&nbsp;&nbsp;",i+="<a class='text-secondary pr-1' onclick='edit_permissions(\""+a.bedname+'","'+a.bedid+'","'+a.vrcode+"\")'><i class='fas fa-user-plus'></i></a>",i+="<a class='text-secondary pr-2' onclick='del_bed_by_cmd(\""+a.bedname+'","'+a.bedid+'","'+a.vrcode+"\")' title='Delete Bed'><i class='far fa-trash-alt' style='width:10.5px'></i></a></td></tr>";var l=$("#toggle-info").hasClass("btn-light")?"d-none ":"";a.group=a.group.replace(/\s/g,""),a.info&&(vrinfo=a.info.trim().replaceAll("\n\n","<br>"),i+="<tr class='info "+l+(""==a.group?"Unspecified":a.group)+"'>",i+="<td colspan=3 style='text-align:left;'>&emsp;&emsp;<div class='d-inline-block align-top mr-1'><font color='#DAA2DC' style='font-weight:bold'>INFO</font> ",i+="<a class='text-secondary pl-1' onclick='copy_to_clipboard("+JSON.stringify(a.info.trim())+")'><i class='far fa-copy'></i></a></div>",i+="<div class='d-inline-block'>"+vrinfo+"</div></td>");var c=e.viewers[a.bedid];if(c)for(var p in c)i+="<tr class='info "+l+(""==a.group?"Unspecified":a.group)+"'>",i+="<td colspan=3 style='text-align:left;'>",i+="<div class='ml-4'>",i+=p.replace("V","<font color='#66ff66' style='font-weight:bold'>V</font>").replace("D","<font color='#fcba03' style='font-weight:bold'>D</font>").replace("M","<font color='#9999ff' style='font-weight:bold'>M</font>")+" "+c[p].join(", ")+"<br>",i+="</div></td>";var v=a.devs;v&&0<v.length&&(i+="<tr class='info "+l+(""==a.group?"Unspecified":a.group)+"'>",i+="<td colspan=3 style='text-align:left;'>&emsp;&emsp;<font color='#00ffff' style='font-weight:bold'>D</font> ",i+=v.join(", ")+"</td>");v=a.filts;v&&0<v.length&&(i+="<tr class='info "+l+(""==a.group?"Unspecified":a.group)+"'>",i+="<td colspan=3 style='text-align:left;'>&emsp;&emsp;<font color='#ff00ff' style='font-weight:bold'>F</font> ",i+=v.join(", ")+"</td>")}if(void 0!==e.unnamed)for(var r in e.unnamed)""==(a=e.unnamed[r]).group&&(t=!0),i+="<tr id='"+a.vrcode+"' class='"+(""==a.group&&(""==a.group||void 0===a.group)?"Unspecified":a.group)+" Unnamed"+n+"'>",i+="<td style='text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>Unnamed</td>",i+="<td title='uploaded "+a.utime+"'>"+a.vrcode+"<a class='text-secondary pl-1' onclick='copy_to_clipboard(\""+a.vrcode+"\")'><i class='far fa-copy'></i></a></td>",i+="<td style='text-align:right'>",i+="<a class='pr-2 text-secondary' onclick='del_vr(\""+a.vrcode+"\")' title='Unregister VR'><i class='far fa-trash-alt'></i></a></td></tr>";$("#vrs").html(i),u&&(orders[m]=u),b&&("SORT_ASC"==orders[m]?orders[m]="SORT_DESC":orders[m]="SORT_ASC"),curr_order=m,$("#groupfilter").val(curr_group).change(),t||$("#groupfilter option[value='Unspecified']").remove(),(void 0===e.unnamed||e.unnamed.length<=0)&&$("#groupfilter option[value='Unnamed']").remove()}})}function add_newgroup(e,t){var d=$("#"+t);"add"===e.value?d.removeClass("d-none"):d.hasClass("d-none")||d.addClass("d-none"),"add-new-group"==t&&$("#move-btn").prop("disabled",!1),"cg-add-group"==t&&$("#cg-move-btn").prop("disabled",!1)}function edit_group(e){$("#prev-groupname").val(e),$("#new-groupname").val(e),$("#del-group").on("click",function(){del_group(e)}),$("#edit-group").modal("show")}function del_group(e){confirm("Are you sure you want to delete group "+e+"? Beds in the group will NOT be deleted.")&&$.ajax({type:"POST",url:mv_apiRoot+"/data.php",data:{job:"del_group",groupname:e},responseType:"text",dataType:"json",success:function(e){location.reload()},error:function(e,t,d){console.log("DEL_GROUP",e)}})}function change_group(){var e=0<selected_beds2.size?[...selected_beds2]:[],t=0<selected_bedids2.size?[...selected_bedids2]:[];$("#selected-beds2").html(e.sort().join()),$("#selected-bedids2").val(t.sort().join()),$("#change-group").modal("show")}function move_bed(e,t,d){0<e.length&&$('select#cg-groupname option[value="'+e+'"]').prop("selected",!0),$("#cg-bedname").html(t),$("#cg-shared-bedname").val(t),$("#cg-shared-bedid").val(d),$("#cg-shared").modal("show")}function edit_permissions(d,e,t){$("#p-bedname").html(d),$("#addp-bedname").val(d),$("#editp-bedname").val(d),$("#editp-vrcode").val(t),$("#editp-bedid").val(e),$.ajax({url:mv_apiRoot+"/data.php",type:"POST",dataType:"json",responseType:"text",data:{job:"get_viewers",bedname:d,bedid:e},success:function(e){var t="";e.forEach(function(e){t+="<tr id='"+e.viewerid+"' style='height:39px'>",t+="<td>"+e.name+" <span class='text-secondary' style='font-size:12px;'>("+e.viewerid+")</span></td>",e.mode*=1,t+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(1==(1&e.mode)?"checked":"")+" value='1'></div></td>",t+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(2==(2&e.mode)?"checked":"")+" value='2'></div></td>",t+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(4==(4&e.mode)?"checked":"")+" value='4'></div></td>",t+="<td><a class='text-secondary' onclick='del_viewer(\""+e.viewerid+'","'+d+"\")'><i class='fa fa-times'></i></a><input type='hidden' id='d-"+e.viewerid+"' name='viewers["+e.viewerid+"][delete]'></td></tr>"}),t+="<tr style='height:39px'><td colspan=6 class='text-center text-primary hover-light' onclick='add_viewer_form()' style='cursor:pointer'><i class='fa fa-plus' aria-hidden='true'></i> Add User</td></tr>",viewers=e,$("#viewers").html(t),$("#reset-editp").attr("onclick",'reset_editp("'+d+'")')}}),$("#editp-alert").addClass("d-none"),$("#editp-btns").removeClass("d-inline-block").addClass("d-none"),$(".close-modal").show(),$("#edit-permissions").modal("show")}function add_viewer(){$("#selected-beds").html([...selected_beds2].sort().join()),$("#selected-bedids").val([...selected_bedids2].sort().join()),$("#share-beds").modal("show")}function share_vr(e){$("#selected-beds").html(e),$("#share-beds").modal("show")}function del_viewer(e){$("#editp-alert").removeClass("d-none"),$("#editp-btns").removeClass("d-none").addClass("d-inline-block"),$(".close-modal").hide();var t="del";"delete"==prompt('Please type "delete" to delete ALL permissions granted to '+e)&&(t+="-all"),$("#d-"+e).val(t),$("#"+e).css({color:"#868e96",cursor:"not-allowed"}).find("select").prop("disabled",!0),$("#"+e).find("a").hide()}function add_viewer_form(){var e=$("#edit-permission").find(".add-viewer").length,t="";t+="<tr class='add-viewer' id='add-viewer-"+e+"' style='height:39px'>",t+="<td><input type='text' class='form-control' name='viewer_"+e+"' placeholder='User ID' style='font-size:12px;' required></td>",t+="<td class='text-center'><input name='new_viewers["+e+"][permission][]' id='m-view-"+e+"' type='checkbox' style='margin-top:4px' value='1'></div></td>",t+="<td class='text-center'><input name='new_viewers["+e+"][permission][]' id='m-download-"+e+"' type='checkbox' style='margin-top:4px' value='2'></div></td>",t+="<td class='text-center'><input name='new_viewers["+e+"][permission][]' id='m-manage-"+e+"' onchange='auto_select(\""+e+"\", this.value)' type='checkbox' style='margin-top:4px' value='4'></div></td>",t+="<td><a class='text-secondary' onclick='$(\"#add-viewer-"+e+"\").remove()'><i class='fa fa-times'></i></a></td></tr>",$("#viewers").find("tr:last").before(t),$("#editp-alert").removeClass("d-none"),$("#editp-btns").removeClass("d-none").addClass("d-inline-block"),$(".close-modal").hide()}function auto_select(e,t){"4"==t&&$("#m-view-"+e).prop("checked",!0)}function toggle_editp(e,t){"0"==t.value?confirm("You might lose the ability to change share settings. Are you sure you want to set "+e+" as a new owner?")?(e={job:"set_owner",viewer:e,bedname:$("#editp-bedname").val(),vrcode:$("#editp-vrcode").val()},$.ajax({type:"POST",url:mv_apiRoot+"/data.php",data:e,responseType:"text",dataType:"json",success:function(e){location.reload()},error:function(e,t,d){console.log("SET_OWNER",e)}})):$(t).prop("checked",!1):($("#editp-alert").removeClass("d-none"),$("#editp-btns").removeClass("d-none").addClass("d-inline-block"),$(".close-modal").hide())}function reset_editp(t){event.preventDefault();var d="";viewers.forEach(function(e){d+="<tr id='"+e.viewerid+"' style='height:39px'>",d+="<td>"+e.name+" <span class='text-secondary' style='font-size:12px;'>("+e.viewerid+")</span></td>",e.mode*=1,d+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(1==(1&e.mode)?"checked":"")+" value='1'></div></td>",d+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(2==(2&e.mode)?"checked":"")+" value='2'></div></td>",d+="<td class='text-center'><input name='viewers["+e.viewerid+"][permission][]' type='checkbox' style='margin-top:4px' onchange='toggle_editp(\""+e.viewerid+"\", this)' "+(4==(4&e.mode)?"checked":"")+" value='4'></div></td>",d+="<td><a class='text-secondary' onclick='del_viewer(\""+e.viewerid+'","'+t+"\")'><i class='fa fa-times'></i></a><input type='hidden' id='d-"+e.viewerid+"' name='viewers["+e.viewerid+"][delete]'></td></tr>"}),$("#viewers").html(d),$("#editp-alert").addClass("d-none"),$("#editp-btns").removeClass("d-inline-block").addClass("d-none"),$(".close-modal").show()}function submit_form(e,t){$("#"+e).submit(),t&&$("#"+t).modal("hide")}function filter_vrs(e){"get_myvrs"==(get_vrs_job=e)?($("#toggle-info").removeClass("d-none"),$("#vr_menu").find("a").removeClass("d-none")):($("#toggle-info").addClass("d-none"),$("#btn-edit-filt").addClass("d-none"),$("#btn-share").addClass("d-none")),selected_beds2.clear(),selected_bedids2.clear(),edit_vrs(curr_order)}function filter_group(e){if($("#sel-all-bed").prop("checked",!1),e=e.replace(/\s/g,""),select_all2=!0,"all"==(curr_group=e))return $("#newvr").show(),void $("#vrs").find("tr").show();$("#vrs").find("tr").hide(),$("#newvr").show(),$("."+$.escapeSelector(e)).show()}function select_bed2(e,t){selected_bedids2.has(t)?(selected_beds2.delete(e),selected_bedids2.delete(t),$("#sel-all-bed").prop("checked",!1),select_all2=!0):(selected_beds2.add(e),selected_bedids2.add(t)),toggle_btns()}function select_all_beds2(){select_all2?$(".bed:visible").each(function(){selected_beds2.add($(this).attr("bedname")),selected_bedids2.add($(this).attr("bedid")),$(this).find("input[type='checkbox']").prop("checked",!0)}):(selected_beds2.clear(),selected_bedids2.clear(),$("#add-vr-side-tab input[type='checkbox']").prop("checked",!1)),select_all2=!select_all2,toggle_btns()}function del_bed(o,e){event.preventDefault(),confirm("Are you sure to delete bed "+e+"?\nPlease be noted that the same bed will be added automatically if it has real time biosignals.")&&(e={job:"del_bed",bedid:o,bedname:e},$.ajax({type:"POST",url:mv_apiRoot+"/data.php",data:e,success:function(e,t,d){$("#"+o).remove(),$("."+o).remove(),$(".viewer-"+o).remove()},error:function(e,t,d){console.log("DELETE_ROOM",t)}}))}function del_beds(){event.preventDefault();var e=0<selected_beds2.size?[...selected_beds2]:[],s=0<selected_bedids2.size?[...selected_bedids2]:[],e='Please type "delete" to make sure you want to delete the following: \n'+e.sort().join();"delete"==prompt(e)&&(e={job:"del_beds"},"get_myvrs"==get_vrs_job?(e.bednames=[...selected_beds2].join(),e.bedids=[...selected_bedids2].join(),bedSocket.emit("req_cmd",e)):(e.bednames=[...selected_beds2].join(),e.bedids=[...selected_bedids2].join(),$.ajax({type:"POST",url:mv_apiRoot+"/data.php",data:e,success:function(e,t,d){for(var o in s)$("#"+s[o]).remove(),$("."+s[o]).remove(),$(".viewer-"+s[o]).remove();selected_beds2.clear(),selected_bedids2.clear(),toggle_btns()},error:function(e,t,d){console.log("DELETE_VR",t)}})))}function del_bed_by_cmd(e,t,d){event.preventDefault(),"delete"==prompt('Please type "delete" to make sure you want to delete bed '+e+". The bed will be deleted from VitalRecorder as long as it is online.")&&(e={job:"del_bed",vrcode:d,bedid:t,bedname:e},console.log(e),bedSocket.emit("req_cmd",e))}function del_vr(e){event.preventDefault(),"delete"==prompt('Please type "delete" to make sure you want to delete vr '+e+".")&&(e={job:"del_vr",vrcode:e},bedSocket.emit("req_cmd",e))}function toggle_btns(){0<selected_beds2.size?($("#btn-edit-group").removeClass("disabled"),$("#btn-del-vrs").removeClass("disabled"),$("#btn-edit-filt").removeClass("disabled"),$("#btn-upgrade-vrs").removeClass("disabled"),$("#btn-share").removeClass("disabled")):($("#btn-edit-group").addClass("disabled"),$("#btn-del-vrs").addClass("disabled"),$("#btn-edit-filt").addClass("disabled"),$("#btn-upgrade-vrs").addClass("disabled"),$("#btn-share").addClass("disabled"))}function add_newport(e){"other"==e.value?$(e).parent().parent().find("input").prop("type","text"):$(e).parent().parent().find("input").prop("type","hidden")}function get_device_name(e,t){var d=devices.find(e=>e.type===t);void 0!==d&&($(e).find("input")[0].value=d.name);d=$(e).find("select")[1],e=$(e).find("input")[2];"demo"==t.toLowerCase()?($(d).prop({required:!1,disabled:!0}).val(""),$(e).prop({disabled:!0})):($(d).prop({required:!0,disabled:!1}),$(e).prop({disabled:!1}))}function toggle_dev_advanced_settings(e=!1){!$("#dev-list-tbl").is(":visible")||e?($("[name=dev-advanced-setting]").addClass("d-none"),$("#form-dev-setting [name=job]").val("edit_dev"),$("[name=dev-advanced-setting]").val(""),$("#dev-list-tbl").show(),$("#add-dev-btn").show(),$("#dev-setting-toggle-btn").html("Advanced Settings")):($("[name=dev-advanced-setting]").removeClass("d-none"),$("#form-dev-setting [name=job]").val("edit_conf"),$("#dev-list-tbl").hide(),$("#add-dev-btn").hide(),$("#dev-setting-toggle-btn").html("Back"),bedSocket.emit("send_vrconf",$("[name=dev-setting-vrcode]").val()))}function render_dev_settings_form(e,t,d){event.stopPropagation(),event.preventDefault(),$("#dev-setting-title").html("Device Settings ("+e+")"),$("[name=dev-setting-vrcode]").val(d),$("[name=dev-setting-bedid]").val(t),$("[name=dev-setting-bedname]").val(e),$.ajax({type:"POST",url:"/vr_devs",data:{bedid:t},dataType:"json",success:function(e,t,d){curr_devs=e,$(".dev-list").remove(),0<e.length?e.forEach(function(e){-1<e.port.indexOf("USB")&&(e.port=e.port.substring(3)),add_device_form(e.type,e.name,e.port,e.ycable)}):add_device_form(),$("#dev-setting").modal("show")},error:function(e,t,d){console.log("REQUEST_VR_DEV",t)}})}function set_filter(){$("#filt-selected-beds").html([...selected_beds2].sort().join()),$("#filt-bed-list").removeClass("d-none"),$("#filt-setting-title").html("Filter Settings"),$("#filt-setting").modal("show")}function check_filters(e){var t=0;$('#form-filt-setting input[name^="filters"]').each(function(){$(this).is(":checked")&&(t+=1)}),3<t&&($(e).prop("checked",!1),alert("You can select up to 3 filters."))}function render_filt_settings_form(e,t,d){event.stopPropagation(),event.preventDefault(),$("#filt-setting-title").html("Filter Settings ("+e+")"),$("[name=filt-setting-bedid]").val(t),$("[name=filt-setting-bedname]").val(e),$.ajax({type:"POST",url:"/vr_filts",data:{bedid:t},dataType:"json",success:function(e,t,d){0<e.length&&e.forEach(function(e){$(":checkbox[value='"+e.modname+"']").prop("checked",!0)}),$("#filt-setting").modal("show")},error:function(e,t,d){console.log("REQUEST_VR_FILT",t)}})}function add_device_form(e="",t="",d="",o=!1){var s=$("#dev-list").find("tr"),a=s.length-1,n=$(s[0]).clone(),i=$.escapeSelector(d);$(n).prop("id","device-form-"+a),$(n).removeClass("d-none").addClass("dev-list");var r=$(n).find("select");$(r).prop("required",!0),$(r[0]).attr("name","devices["+a+"][type]").attr("onchange","get_device_name($('#device-form-"+a+"'), $(this).val())").val(e);s=$(n).find("input");$(s).prop("required",!0),$(s[0]).attr("name","devices["+a+"][name]").val(t),$(r[1]).attr("name","devices["+a+"][port]"),"demo"==e.toLowerCase()&&$(r[1]).prop({required:!1,disabled:!0}),$(s[1]).attr("name","devices["+a+"][port_other]"),$(s[1]).prop("required",!1),0<d.length&&0<$("[name=device-port] option[value="+i+"]").length?$(r[1]).val(d):0<d.length&&0==$("[name=device-port] option[value="+i+"]").length&&($(r[1]).val("other"),$(s[1]).prop({type:"text"}).val(d)),o="1"==o,$(s[2]).attr("name","devices["+a+"][ycable]").prop({checked:o,required:!1}),o?$(s[2]).attr("value","1"):$(s[2]).attr("value","0"),$($(n).find("td.dev-btns")[0]).append("<a onclick='del_device_form(\"device-form-"+a+"\")' style='color:red;vertical-align:-webkit-baseline-middle'><i class='fa fa-lg fa-times-circle'></i></a>"),$("#dev-list").append(n),a>=devices.length&&$(".add-device").css("display","none")}function del_device_form(e){var t=$("select[name='devices["+e.substr(12)+"][type]']").val();confirm("Are you sure you want to delete "+t+"?")&&($("#"+e).remove(),$(".device-form").length<=1&&add_device_form())}function add_event(e,t,d){t=wm_rooms[t];t.dtEnd+60<t.dtplayer?alert(e+" offline. Cannot add an event remotely."):($("#add-event-title").html("Add Event ("+e+")"),e=("0"+(e=new Date).getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2),$("#add-evt-dt").val(Math.floor(Date.now()/1e3)),$("#evt-label").html("["+e+"] Please enter an event message."),$("#add-evt-vrcode").val(d),$("#add-event").modal("show"))}function update_vr_preloader(e){$("#wm-rooms").find("a.update-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.restart-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.reboot-vr-"+e).addClass("disabled"),$("#update-stat-"+e).html("<small>Upgrading VR...<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true' style='vertical-align:baseline'></span><span class='sr-only'>Loading...</span></small>")}function update_setInterval(o){var e={job:"is_updated",vrcode:o},s=0,a=setInterval(function(){$.ajax({type:"POST",url:mv_apiRoot+"/cmd.php",dataType:"json",responseType:"text",data:e,success:function(e,t,d){e.success&&(setTimeout(function(){Cookies.remove("update-"+o)}),clearInterval(a),$("#update-stat-"+o).html("")),8<s&&(clearInterval(a),$("#update-stat-"+o).html("")),s+=1},error:function(e){console.log(e)}})},5e3)}function update_vr(e,t){confirm("Upgrade VR "+t+" remotely?")&&(e={job:"update_vr",vrcode:e},bedSocket.emit("req_cmd",e))}function update_vrs(){if(confirm("Upgrade selected VRs "+[...selected_beds2].join()+" remotely?")){var e,t=[...selected_bedids2];for(e in t){var d=wm_rooms[t[e]].shareid;console.log(d);d={job:"update_vr",vrcode:d};bedSocket.emit("req_cmd",d)}}}function restart_vr_preloader(e){$("#wm-rooms").find("a.update-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.restart-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.reboot-vr-"+e).addClass("disabled"),$("#update-stat-"+e).html("<small>Restarting VR...<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true' style='vertical-align:baseline'></span><span class='sr-only'>Loading...</span></small>")}function restart_setInterval(o,e){var t={job:"is_restarted",vrcode:o,bedid:e},s=0,a=setInterval(function(){$.ajax({type:"POST",url:mv_apiRoot+"/cmd.php",dataType:"json",responseType:"text",data:t,success:function(e,t,d){e.success&&(setTimeout(function(){Cookies.remove("restart-"+o)}),clearInterval(a),$("#update-stat-"+o).html("")),8<s&&(clearInterval(a),$("#update-stat-"+o).html("")),s+=1},error:function(e){console.log(e)}})},5e3)}function restart_vr(e,t){confirm("Restart VR "+t+" remotely?")&&(e={job:"restart_vr",vrcode:e},bedSocket.emit("req_cmd",e))}function reboot_vr_preloader(e){$("#wm-rooms").find("a.update-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.restart-vr-"+e).addClass("disabled"),$("#wm-rooms").find("a.reboot-vr-"+e).addClass("disabled"),$("#update-stat-"+e).html("<small>Rebooting...<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true' style='vertical-align:baseline'></span><span class='sr-only'>Loading...</span></small>")}function reboot_setInterval(o,e){var t={job:"is_rebooted",vrcode:o,bedid:e},s=0,a=setInterval(function(){$.ajax({type:"POST",url:mv_apiRoot+"/cmd.php",dataType:"json",responseType:"text",data:t,success:function(e,t,d){e.success&&(setTimeout(function(){Cookies.remove("reboot-"+o)}),clearInterval(a),$("#update-stat-"+o).html("")),8<s&&(clearInterval(a),$("#update-stat-"+o).html("")),s+=1},error:function(e){console.log(e)}})},5e3)}function reboot_vr(e,t){confirm("Reboot VR "+t+" remotely?")&&(e={job:"reboot_vr",vrcode:e},bedSocket.emit("req_cmd",e))}function toggle_add_viewer(){$("#m-view").is(":checked")||$("#m-download").is(":checked")||$("#m-manage").is(":checked")?$("#add-viewer").removeClass("d-none"):($("#viewerid").val(""),$("#add-viewer").addClass("d-none")),$("#m-manage").is(":checked")&&$("#m-view").attr("checked",!0)}jQuery.fn.single_double_click=function(o,s,a){return this.each(function(){var t=0,d=this;jQuery(this).click(function(e){1==++t&&setTimeout(function(){(1==t?o:s).call(d,e),t=0},a||300)})})},$(document).ready(function(e){$("#dev-setting").on("hidden.bs.modal",function(e){toggle_dev_advanced_settings(!0)}),$("#share-beds").on("shown.bs.modal",function(){$("#viewerid").trigger("focus")}),$("#edit-group").on("shown.bs.modal",function(){$("#new-groupname").trigger("focus")}),$("#add-event").on("shown.bs.modal",function(){$("#evt").trigger("focus")}),$("#add-evt").on("submit",function(e){e.preventDefault();e=$("#add-evt-dt").val(),e={job:"add_evt",vrcode:$("#add-evt-vrcode").val(),dt:e,msg:$("#evt").val()};bedSocket.emit("req_cmd",e),$("#add-evt").trigger("reset"),$("#add-event").modal("hide")}),$("#form-dev-setting").on("submit",function(e){e.preventDefault(),$("#dev-setting").modal("hide");var e=$(this).serializeArray(),t=!1;if("edit_dev"==$("#form-dev-setting [name=job]").val()){var o={};if($.each(e,function(e,t){if(-1<t.name.indexOf("devices")){var e=parseInt(t.name.substr(8)),d="";if(-1<t.name.indexOf("name")&&(d="name"),-1<t.name.indexOf("type")&&(d="type"),-1<t.name.indexOf("ycable")&&(d="ycable"),-1<t.name.indexOf("port")||-1<t.name.indexOf("port_other")){if(""==t.value)return;d="port"}e in o||(o[e]={}),o[e][d]=t.value}}),curr_devs.length!=Object.keys(o).length)t=!0;else for(var d in curr_devs){var s=curr_devs[d],a=!1;for(d in o){var n=o[d];if(n.name==s.name){for(var i in a=!0,void 0===n.ycable?n.ycable="0":n.ycable="1",n)if(n[i]!=s[i]){t=!0;break}break}}if(!a){t=!0;break}}}else t=!0;t&&(e=$(this).serialize(),bedSocket.emit("req_cmd",e))}),$("#form-filt-setting").on("submit",function(e){var t;e.preventDefault(),$("#filt-setting").modal("hide"),0<$("input[name='filt-setting-bedid']").val().length?bedSocket.emit("req_cmd",$(this).serialize()):(t=[],$("input:checkbox[name='filters[]']:checked").each(function(){t.push($(this).val())}),e={job:"edit_filts",bednames:$("#filt-selected-beds").html(),filters:t.join()},bedSocket.emit("req_cmd",e)),select_all2=!1,select_all_beds2(),$("#form-filt-setting input[type=checkbox]").prop("checked",!1),$("#filt-bed-list").addClass("d-none")}),$("#share-view").on("submit",function(e){e.preventDefault();e=0;$("#m-view").is(":checked")&&(e+=1),$("#m-download").is(":checked")&&(e+=2),$("#m-manage").is(":checked")&&(e+=4);e={job:"share",mode:e,bednames:$("#selected-beds").html(),bedids:$("#selected-bedids").val()};e.viewers=$("#viewerid").val().replace(/ /g,""),0<e.viewers.length&&$.ajax({url:mv_apiRoot+"/data.php",type:"POST",dataType:"json",responseType:"text",data:e,success:function(e){e.msg&&alert(e.msg),$("#add-vr-side-tab").hasClass("show-tab")?(edit_vrs(curr_order),$("#share-beds").removeClass("show"),$("#share-view").trigger("reset"),$("#add-viewer").addClass("d-none"),$("#share-view input[type=checkbox]").prop("checked",!1),selected_beds2.clear(),selected_bedids2.clear()):location.reload()},error:function(e,t,d){console.log("SHARE_VIEW",t)}})}),$("#add-grp").on("submit",function(e){e.preventDefault();e=$("#grpname").val();$.ajax({url:mv_apiRoot+"/data.php",type:"POST",dataType:"json",responseType:"text",data:{job:"add_group",groupname:e},success:function(e){location.reload()},error:function(e,t,d){console.log("ADD_GROUP",t)}})}),$("#group-edit").on("submit",function(e){e.preventDefault();var t=$("#prev-groupname").val(),e=$("#new-groupname").val();$.ajax({url:mv_apiRoot+"/data.php",type:"POST",dataType:"json",responseType:"text",data:{job:"edit_group",groupname:t,new_name:e},success:function(e){location.reload()},error:function(e,t,d){console.log("EDIT_GROUP",t)}})}),$("#move-vrs").on("submit",function(e){e.preventDefault();var t={job:"move_vrs",bednames:$("#selected-beds2").html(),bedids:$("#selected-bedids2").val()},e=$("#group-name").val().trim();$("#add-new-group").hasClass("d-none")||(e=$("#new-group-name").val().trim()),t.groupname=e,$.ajax({type:"POST",url:mv_apiRoot+"/data.php",dataType:"json",responseType:"text",data:t,success:function(e){$("#change-group").modal("hide"),$("#move-vrs").trigger("reset"),$("#add-new-group").addClass("d-none"),edit_vrs(curr_order),selected_beds2.clear(),selected_bedids2.clear(),toggle_btns()},error:function(e,t,d){console.log("MOVE_VRS",t)}})}),$("#cg-shared-vr").on("submit",function(e){e.preventDefault();var t={job:"move_vrs"};t.bednames=$("#cg-shared-bedname").val(),t.bedids=$("#cg-shared-bedid").val();e=$("#cg-groupname").val();$("#cg-add-group").hasClass("d-none")||(e=$("#cg-new-group").val().trim()),t.groupname=e,$.ajax({type:"POST",url:mv_apiRoot+"/data.php",dataType:"json",responseType:"text",data:t,success:function(e){location.reload()},error:function(e,t,d){console.log("MOVE_VRS",t)}})}),$("#edit-permission").on("submit",function(e){e.preventDefault();var t=$("#editp-bedname").val();$.ajax({type:"POST",url:mv_apiRoot+"/data.php",data:$(this).serialize(),responseType:"text",dataType:"json",success:function(e){viewers=e,reset_editp(t),$("#add-vr-side-tab").hasClass("show-tab")&&edit_vrs(curr_order)},error:function(e,t,d){console.log("DEL_VIEW",e)}})}),$("#log-vr-btn").on("click",function(e){e.preventDefault();bedSocket.emit("req_cmd",{job:"log_data"})}),$("#del-vr-btn").on("click",function(e){e.preventDefault();bedSocket.emit("req_cmd",{job:"del_data"})}),"N"==admin_yn&&(get_vrs_job="get_sharedvrs",$("#vrfilter option:eq(1)").attr("selected","selected"))});