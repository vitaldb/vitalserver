var files,bedlist,trklist,filesbytrk,apiRoot="/my-files",selected_trks=new Set,check_all=!0,selected_files=new Set,sorting_idx=0,sorting_dir="asc",comparators=[{asc:function(e,t){return e.filename.localeCompare(t.filename,void 0,{numeric:!0,sensitivity:"base"})},desc:function(e,t){return t.filename.localeCompare(e.filename,void 0,{numeric:!0,sensitivity:"base"})}},{asc:function(e,t){return e.dtstart-t.dtstart},desc:function(e,t){return t.dtstart-e.dtstart}},{asc:function(e,t){return e.dtend-t.dtend},desc:function(e,t){return t.dtend-e.dtend}},{asc:function(e,t){return e.dtupload-t.dtupload},desc:function(e,t){return t.dtupload-e.dtupload}},{asc:function(e,t){return e.filesize-t.filesize},desc:function(e,t){return t.filesize-e.filesize}}];function format_bytes(e,t){if(0==e)return"0 Bytes";var i=t<=0?0:t||2,t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(i))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}function hide_sort_icon(e){e==sorting_idx?$("#"+sorting_idx+"_sort").attr("src","/static/img/s_"+sorting_dir+".png"):$("#"+e+"_sort").css("display","none")}function change_sort_icon(e){var t;e==sorting_idx?(t="asc"===sorting_dir?"desc":"asc",$("#"+sorting_idx+"_sort").attr("src","/static/img/s_"+t+".png")):$("#"+e+"_sort").attr("src","/static/img/s_asc.png"),$("#"+e+"_sort").css("display","")}function sort_cases(e){files.length<1||(clear_checkboxes(),$("#"+sorting_idx+"_sort").css("display","none"),sorting_dir=e==sorting_idx&&"asc"==sorting_dir?"desc":"asc",sorting_idx=e,$("#"+sorting_idx+"_sort").css("display",""),change_sort_icon(e),update_table())}function date_onchange(e){var t;"sdate"==e.id?(t=$("#edate"),$(t).attr("min",e.value),new Date($(e).val()).getTime()>new Date($(t).val()).getTime()&&$(t).val($(e).val())):(t=$("#sdate"),$(t).attr("max",e.value),new Date($(e).val()).getTime()<new Date($(t).val()).getTime()&&$(t).val($(e).val())),request_data()}function toggle_btn(){0<selected_files.size?$(".flexible-btn").attr("disabled",!1):$(".flexible-btn").attr("disabled",!0)}function create_toast(e,t,i,s){t='<div style="max-width: 100% !important;" id="'+(e=e.split(".")[0])+'" class="toast show '+t+'" role="status" aria-live="polite" aria-atomic="true">';t+='<div class="toast-header">',t+='<span class="mr-auto">'+i+"</span>",t+='<button type="button" class="ml-2 mb-1 close" onclick="$(\'#'+e+"').hide()\">",t+='<span aria-hidden="true">&times;</span>',t+="</button>",t+="</div>",t+='<div class="toast-body">',t+=s,t+="</div></div>",document.getElementById("toasts").innerHTML+=t}function select_file(e){$("#sel-"+e).prop("checked")?selected_files.add(e):selected_files.delete(e),toggle_btn()}function select_all(){for(var e in files){var t=files[e].filename;$("#row-"+t).is(":visible")&&($("#sel-"+t).prop("checked",check_all),check_all&&!selected_files.has(t)&&selected_files.add(t))}check_all||(selected_files=new Set),check_all=!check_all,toggle_btn()}function clear_checkboxes(){0<selected_files.size&&(Array.from(selected_files).forEach(function(e){$("#sel-"+e).prop("checked",!1),selected_files.delete(e)}),$("#sel-all").prop("checked",!1),toggle_btn())}function preview_file(e){$("#stats").addClass("d-none"),$("#view-stats-btn").removeClass("d-none"),$("#iframe_preview").removeClass("d-none"),$("#iframe_preview").attr("src","/webview?filename="+e+".vital")}function download_file(e){e+=".vital",window.open("/my-files/download?filename="+e)}Set.prototype.union=function(e){var t,i=new Set(this);for(t in e=[...e]){var s=e[t];i.add(s)}return i},Set.prototype.intersection=function(e){var t,i=new Set;for(t in e=[...e]){var s=e[t];this.has(s)&&i.add(s)}return i};var ccnt=0;function download_files(){if(0!==selected_files.size){var e,t=Array.from(selected_files);for(e in t)download_file(t[e]);clear_checkboxes()}else alert("Please select at least one file.")}function delete_files(){0!==selected_files.size?confirm("Are you sure you want to delete selected files?")&&($.ajax({type:"POST",url:apiRoot+"/data.php",data:{job:"delete",files:Array.from(selected_files)},dataType:"json",success:function(){request_data()}}),window.location.reload()):alert("Please select at least one file.")}function request_data(){var e,t;$("#search").attr("disabled")||(e={job:"list"},t=60*(new Date).getTimezoneOffset(),e.sdate=Math.floor(new Date($("#sdate").val()).getTime()/1e3)+t,e.edate=Math.floor(new Date($("#edate").val()).getTime()/1e3)+86400+t,"all"==(t=$("#bedlist").val())?e.bedname=$("#bedname").val().trim():e.selected_bed=t,$.ajax({type:"POST",url:apiRoot+"/data.php",data:e,dataType:"json",contentEncoding:"gzip",async:!0,beforeSend:function(){$("#search").attr("disabled",!0).html("<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true' style='vertical-align:baseline'></span>")},success:on_list_received,complete:function(){$("#search").attr("disabled",!1).html("<i class='fas fa-search'></i>"),0<files.length&&preview_file(files[0].filename)}}))}function on_list_received(e){$("#sel-all").prop("checked",!1),selected_files=new Set,check_all=!0,files=e,trklist=new Set,filesbytrk={},update_table(),update_trklist()}function checkDigit(e){return e=e<10?"0"+e:e}function ut2d(e,t=!1){var i=new Date(1e3*e),s=i.getFullYear(),a=checkDigit(i.getMonth()+1),l=checkDigit(i.getDate()),e="";return t&&(e+=s+"-"+a+"-"+l+" "),e+=checkDigit(i.getHours())+":"+checkDigit(i.getMinutes())+":"+checkDigit(i.getSeconds())}function tago(e){e={ss:Math.floor((new Date-new Date(1e3*e))/1e3)};return e.y=Math.floor(e.ss/31536e3),0<e.y?e.y+" y ago":(e.m=Math.floor(e.ss/2592e3),0<e.m?e.m+" m ago":(e.d=Math.floor(e.ss/86400),0<e.d?e.d+" d ago":(e.hh=Math.floor(e.ss/3600),0<e.hh?e.hh+" h ago":(e.mm=Math.floor(e.ss/60),0<e.mm?e.mm+" m ago":e.ss+" s ago"))))}function filter_trk(e){e=e.toLowerCase(),$("#trklist option").show(),$("#trklist option").filter(function(){return this.value.toLowerCase().indexOf(e)<0}).hide()}function add_trk_btn(e){if(!selected_trks.has(e)){selected_trks.add(e);var t=[...selected_trks];t.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"})});var i,s="";for(i in t)s+="<li id='"+(e=t[i])+"' class='list-group-item'>"+e+" <a class='float-right' onclick='remove_trk(\""+e+"\");'>&times;</a></li>";$("#selected-trks").html(s)}}function add_trk(e=!1){e?$("#trklist option").each(function(){$(this).is(":visible")&&add_trk_btn(this.value)}):$.each($("#trklist").val(),function(e,t){add_trk_btn(t)}),filter_files_by_trks()}function remove_trk(e){selected_trks.delete(e),$("[id='"+e+"']").remove(),filter_files_by_trks()}function clear_trk(){$.each([...selected_trks],function(e,t){selected_trks.delete(t),$("[id='"+t+"']").remove()}),$("#file-table").find("tr").show(),update_filecount()}function filter_files_by_trks(){if(0!=selected_trks.size){var e,t=$("#operator").val(),i=new Set;for(e in $("#file-table").find("tbody tr").hide(),"AND"==t?[...selected_trks].forEach(function(e,t){i=0!=t?i.intersection(filesbytrk[e]):filesbytrk[e]}):[...selected_trks].forEach(function(e){i=i.union(filesbytrk[e])}),i=[...i]){var s=i[e];$("#row-"+s).show()}update_filecount()}else $("#file-table").find("tr").show()}function update_trklist(){var i=$("#trklist"),e=[...trklist];e.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"})}),$(i).html(""),$.each(e,function(e,t){t=new Option(t,t);$(i).append(t)}),$("#trklist option").dblclick(function(){$("[id='"+this.value+"']").length<=0&&(add_trk_btn(this.value),filter_files_by_trks())})}function update_bedlist(s){var a=$("#bedlist");$(a).html(""),$(a).append(new Option("ALL","all")),bedlist.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"})}),$.each(bedlist,function(e,t){var i=new Option(t,t);t==s&&$(i).prop("selected",!0),$(a).append(i)})}function update_table(){var e=$("#file-table").find("tbody");if($("#file-count").html("Total 0"),files.length<1)alert("Files not found.");else{files.sort(comparators[sorting_idx][sorting_dir]);var t,i="";for(t in files){var s=files[t],a='<tr id="row-'+s.filename+'" ';0<$("#row-"+s.filename).length&&!$("#row-"+s.filename).is(":visible")&&(a+='style="display:none"'),a+=">",a+='<td><div class="custom-control custom-checkbox" style="margin-top: -1px;"><input type="checkbox" onchange="select_file(\''+s.filename+'\')" class="custom-control-input" id="sel-'+s.filename+'"><label class="custom-control-label" for="sel-'+s.filename+'"></label></div></td>',a+='<td style="vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><span id="name-'+s.filename+'" onclick="preview_file(\''+s.filename+'\')" style="cursor: pointer;vertical-align:middle">'+s.filename+'</span>&ensp;<button class="btn btn-light3 btn-sm" onclick="download_file(\''+s.filename+'\')" style="height:30px"><i class="fa fa-sm fa-download" style="vertical-align:middle"></i></button></td>',a+='<td style="vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+ut2d(s.dtstart,!0)+"</td>",a+='<td style="vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+ut2d(s.dtend)+"</td>",a+='<td align="right" style="vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+tago(s.dtupload)+"</td>",i+=a+='<td align="right" style="vertical-align:middle;">'+format_bytes(s.filesize,2)+"</td></tr>",s.trks.forEach(e=>{void 0===filesbytrk[e]&&(filesbytrk[e]=new Set),filesbytrk[e].add(s.filename),trklist.add(e)})}$(e).html(i),update_filecount()}}function update_filecount(){$("#file-count").html("Total "+$("#file-table").find("tbody").find("tr:visible").length)}$(document).ready(function(e){var t=$("#"+sorting_idx+"_sort");t.attr("src","/static/img/s_desc.png"),t.attr("onMouseOver","this.src='/static/img/s_"+("asc"===sorting_dir?"desc":"asc")+".png'"),t.attr("onMouseOut","this.src='/static/img/s_"+("asc"===sorting_dir?"asc":"desc")+".png'"),$("input[type=date]").change(function(e){13!==e.keyCode||$(this).val().startsWith("0")||("sdate"==this.id&&new Date($(this).val()).getTime()<=new Date($("#edate").val()).getTime()||"edate"==this.id&&new Date($("#sdate").val()).getTime()<=new Date($(this).val()).getTime())&&request_data();e=+$(this).val().substring(0,4);"sdate"==this.id&&new Date($(this).val()).getTime()>new Date($("#edate").val()).getTime()&&2e3<e&&$("#edate").val($("#sdate").val()),"edate"==this.id&&new Date($(this).val()).getTime()<new Date($("#sdate").val()).getTime()&&2e3<e&&$("#sdate").val($("#edate").val())}),$("input[type=date]").keypress(function(e){return 13===e.keyCode&&(("sdate"==this.id&&new Date($(this).val()).getTime()<=new Date($("#edate").val()).getTime()||"edate"==this.id&&new Date($("#sdate").val()).getTime()<=new Date($(this).val()).getTime())&&void request_data())});var i=new Date,s=i.getFullYear()+"-"+("0"+(i.getMonth()+1)).slice(-2)+"-"+("0"+i.getDate()).slice(-2),t=document.getElementById("sdate"),i=document.getElementById("edate");t.value=t.max=i.value=i.max=s,request_data()});