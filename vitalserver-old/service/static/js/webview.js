const recfmt={0:{name:"FMT_NULL",size:0},1:{name:"FMT_FLOAT",size:4},2:{name:"FMT_DOUBLE",size:8},3:{name:"FMT_CHAR",size:1},4:{name:"FMT_BYTE",size:1},5:{name:"FMT_SHORT",size:2},6:{name:"FMT_WORD",size:2},7:{name:"FMT_LONG",size:4},8:{name:"FMT_DWORD",size:4}},montypes={1:"ECG_WAV",2:"ECG_HR",3:"ECG_PVC",4:"IABP_WAV",5:"IABP_SBP",6:"IABP_DBP",7:"IABP_MBP",8:"PLETH_WAV",9:"PLETH_HR",10:"PLETH_SPO2",11:"RESP_WAV",12:"RESP_RR",13:"CO2_WAV",14:"CO2_RR",15:"CO2_CONC",16:"NIBP_SBP",17:"NIBP_DBP",18:"NIBP_MBP",19:"BT",20:"CVP_WAV",21:"CVP_CVP",22:"EEG_BIS",23:"TV",24:"MV",25:"PIP",26:"AGENT1_NAME",27:"AGENT1_CONC",28:"AGENT2_NAME",29:"AGENT2_CONC",30:"DRUG1_NAME",31:"DRUG1_CE",32:"DRUG2_NAME",33:"DRUG2_CE",34:"CO",36:"EEG_SEF",38:"PEEP",39:"ECG_ST",40:"AGENT3_NAME",41:"AGENT3_CONC",42:"STO2_L",43:"STO2_R",44:"EEG_WAV",45:"FLUID_RATE",46:"FLUID_TOTAL",47:"SVV",49:"DRUG3_NAME",50:"DRUG3_CE",52:"FILT1_1",53:"FILT1_2",54:"FILT2_1",55:"FILT2_2",56:"FILT3_1",57:"FILT3_2",58:"FILT4_1",59:"FILT4_2",60:"FILT5_1",61:"FILT5_2",62:"FILT6_1",63:"FILT6_2",64:"FILT7_1",65:"FILT7_2",66:"FILT8_1",67:"FILT8_2",70:"PSI",71:"PVI",72:"SPHB",73:"ORI",75:"ASKNA",76:"PAP_SBP",77:"PAP_MBP",78:"PAP_DBP",79:"FEM_SBP",80:"FEM_MBP",81:"FEM_DBP",82:"EEG_SEFL",83:"EEG_SEFR",84:"EEG_SR",85:"TOF_RATIO",86:"TOF_CNT",87:"SKNA_WAV",88:"ICP",89:"CPP",90:"ICP_WAV",91:"PAP_WAV",92:"FEM_WAV",93:"ALARM_LEVEL",95:"EEGL_WAV",96:"EEGR_WAV",97:"ANII",98:"ANIM",99:"PTC_CNT"},ttypes={1:"W",2:"N",5:"S"};var file,data,filestart=0,fileend=0,fileSize=0,tid2did={},devs={},evt_id=null;function _progress(a){return new Promise(async e=>{var t=(offset/data.byteLength*100).toFixed(2);await preloader(a,"PARSING...",t).then(e)})}function arrayBufferToString(e){e=new Uint8Array(e),e=String.fromCharCode.apply(String,e);if(/[\u0080-\uffff]/.test(e))throw new Error("this string seems to contain (still encoded) multibytes");return e}function typedArrayToBuffer(e){return e.buffer.slice(0,e.byteLength)}function get_filename(e){var t=null,a=e.split(";");if(1<a.length)for(var i in a=a[1].split("&")){var n=a[i];-1<n.indexOf("filename")&&(t=n.split("=")[1])}else t=(t=e.split("/"))[t.length-1];return t}function requestVital(e,t=!1){var a=get_filename(e),i=t?draw_moniview:draw_trackview;preloader(a,"LOADING..."),fetch(e).then(function(e){return e.blob()}).then(function(e){parseVital(e,a,i)})}function parseVital(e,t,I){fileSize=(file=e).size,file.name=t,tid2did={},devs={},offset=fileend=filestart=0;data=null;var a=async function(e){if(null==e.target.error){var t,a;if("VITA"!=arrayBufferToString((data=typedArrayToBuffer(data=pako.inflate(e.target.result))).slice(0,4)))return void console.log(arrayBufferToString(data.slice(0,4)));offset=20,console.time("parsing"),console.log("File Size:"+fileSize+"\nUnzipped:"+data.byteLength),await _progress();for(var i=data.byteLength/15;offset<data.byteLength;){var n=new Uint8Array(data.slice(offset,offset+1))[0];offset+=1;var r,o,l,s,f,_,c,d,m,u,p,v=new Int32Array(data.slice(offset,offset+4))[0],h=offset+=4;9==n&&(t=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,l=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,_=arrayBufferToString(data.slice(offset,offset+l)),offset+=l,s=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,c=arrayBufferToString(data.slice(offset,offset+s)),offset+=s,f=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,d=arrayBufferToString(data.slice(offset,offset+f)),t in devs?((u=devs[t]).dtype=_,u.dname=c,u.port=d):devs[t]=new dev(t,_,c,d)),0==n&&(a=new Int16Array(data.slice(offset,offset+2))[0],offset+=2,E=new Uint8Array(data.slice(offset,offset+1))[0],offset+=1,x=new Uint8Array(data.slice(offset,offset+1))[0],offset+=1,m=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,"EVENT"==(r=arrayBufferToString(data.slice(offset,offset+m)))&&(evt_id=a),offset+=m,p=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,"EVENT"!=r&&(o=arrayBufferToString(data.slice(offset,offset+p))),offset+=p,l=new Float32Array(data.slice(offset,offset+4))[0],offset+=4,s=new Float32Array(data.slice(offset,offset+4))[0],offset+=4,f=new Uint32Array(data.slice(offset,offset+4))[0],offset+=4,_=new Float32Array(data.slice(offset,offset+4))[0],offset+=4,c=new Float64Array(data.slice(offset,offset+8))[0],offset+=8,d=new Float64Array(data.slice(offset,offset+8))[0],offset+=8,m=new Uint8Array(data.slice(offset,offset+1))[0],offset+=1,t=new Int32Array(data.slice(offset,offset+4))[0],(tid2did[a]=t)in devs?a in(u=devs[t]).trks?((p=u.trks[a]).did=t,p.ttype=E,p.tname=r,p.rfmt=x,p.unit=o,p.mindisp=l,p.maxdisp=s,p.color=f,p.srate=_,p.gain=c,p.bias=d,p.montype=m):devs[t].trks[a]=new trk(a,t,E,r,x,o,l,s,f,_,c,d,m):(devs[t]=new dev(t),devs[t].trks[a]=new trk(a,t,E,r,x,o,l,s,f,_,c,d,m))),offset=h+v}for(offset=20;offset<data.byteLength;){n=new Uint8Array(data.slice(offset,offset+1))[0];offset+=1;var T,g,E,x,y,w,A,F,v=new Int32Array(data.slice(offset,offset+4))[0],h=offset+=4;1==n&&(offset+=2,T=null,(g=data.slice(offset,offset+8)).byteLength%8==0&&(T=new Float64Array(g)[0]),offset+=8,a=new Int16Array(data.slice(offset,offset+2))[0],t=tid2did[a],offset+=2,E=devs[t].trks[a].ttype,y=(x=recfmt[devs[t].trks[a].rfmt]).name,F=x.size,w=null,"W"==E&&(A=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,g=data.slice(offset,offset+F*A),"FMT_FLOAT"==y&&g.byteLength%4==0?w=new Float32Array(g):"FMT_WORD"!=y&&"FMT_SHORT"!=y||g.byteLength%2!=0?"FMT_DOUBLE"==y?w=new Float64Array(g):"FMT_LONG"!=y&&"FMT_DWORD"!=y||(w=new Int32Array(g)):w=new Int16Array(g)),"N"==E&&("FMT_FLOAT"==y?w=new Float32Array(data.slice(offset,offset+F))[0]:"FMT_DOUBLE"==y?w=new Float64Array(data.slice(offset,offset+F)):"FMT_WORD"==y||"FMT_SHORT"==y?w=new Int16Array(data.slice(offset,offset+F)):"FMT_LONG"!=y&&"FMT_DWORD"!=y||(w=new Int32Array(data.slice(offset,offset+F)))),"S"==E&&(offset+=4,F=new Int32Array(data.slice(offset,offset+4))[0],offset+=4,g=new Uint8Array(data.slice(offset,offset+F)),w=new TextDecoder("utf-8").decode(g)),T&&((0==filestart||T<filestart)&&(filestart=T),(0==fileend||fileend<T)&&(fileend=T),devs[t].trks[a].recs.push({dt:T,vals:w}))),i<=(offset=h+v)&&31457280<data.byteLength&&await _progress().then(async function(){i+=data.byteLength/15})}console.timeEnd("parsing")}else console.log("Read error: "+e.target.error);await _progress().then(justify_all_tracks).then(I)};(function(){console.log("File Name: "+t);var e=new FileReader;e.onloadend=a,e.readAsArrayBuffer(file)})()}function toHex(e){return("0"+Number(e).toString(16)).slice(3).toUpperCase()}function trk(e,t=null,a=null,i=null,n=null,r=null,o=null,l=null,s=null,f=null,_=null,c=null,d=null){this.tid=e,this.did=t,this.ttype=ttypes[a],this.rfmt=n,this.tname=i,this.unit=r,this.mindisp=o,this.maxdisp=l,this.color="#"+toHex(s),this.srate=f,this.gain=_,this.bias=c,this.montype=montypes[d],this.recs=[],this.data=null,trk.prototype.justify_recs=function(){if(0!=this.recs.length){if(this.recs.sort(function(e,t){return e.dt-t.dt}),"W"==this.ttype){var e,t=this.srate,a=Math.ceil(get_caselen()*t),i=new Uint8Array(a),n=(this.mindisp-this.bias)/this.gain,r=(this.maxdisp-this.bias)/this.gain;for(e in this.recs){var o=this.recs[e],l=parseInt((o.dt-filestart)*t);o.vals&&"object"==typeof o.vals?o.vals.forEach(function(e){0==e?i[l]=0:((e=(e-n)/(r-n)*254+1)<1?e=1:255<e&&(e=255),i[l]=e),l++}):console.log(e,o,this.tname)}this.prev=i}if("N"==this.ttype||"S"==this.ttype)for(var s in this.data=[],this.recs){o=this.recs[s];this.data.push([o.dt-filestart,o.vals])}}}}function dev(e,t=null,a=null,i=null){this.did=e,this.dtype=t,this.dname=a,this.port=i,this.trks={}}const DEVICE_ORDERS=["SNUADC","SNUADCW","SNUADCM","Solar8000","Primus","Datex-Ohmeda","Orchestra","BIS","Invos","FMS","Vigilance","EV1000","Vigileo","CardioQ"],DEVICE_HEIGHT=25,HEADER_WIDTH=140;var undefined,tracks=[],tw=640,tx=HEADER_WIDTH,canvas_file=document.getElementById("file_preview"),ctx_file=canvas_file.getContext("2d"),progress=0,dragx=-1,dragy=-1,offset=-35,is_zooming=!1;function stotime(e){var t=new Date(1e3*(e+filestart)),a=t.getHours(),e=t.getMinutes(),t=t.getSeconds();return("0"+a).slice(-2)+":"+("0"+e).slice(-2)+":"+("0"+t).slice(-2)}function draw_time(e=!1){var t=get_caselen(),a=get_cookie("fit")?parseInt(get_cookie("fit")):0;e&&(tw=a?100*t:canvas_file.width-HEADER_WIDTH);ctx_file.fillStyle="#464646",ctx_file.fillRect(0,0,canvas_file.width,DEVICE_HEIGHT),ctx_file.font="100 12px arial",ctx_file.textBaseline="middle",ctx_file.textAlign="left",ctx_file.fillStyle="#ffffff",ctx_file.fillText("TIME",8,0+DEVICE_HEIGHT-7),ctx_file.lineWidth=1,ctx_file.strokeStyle="#ffffff",ctx_file.textBaseline="top";for(var i=(canvas_file.width-HEADER_WIDTH)/5,n=HEADER_WIDTH;n<=canvas_file.width;n+=i){var r=stotime((n-tx)*t/tw);ctx_file.textAlign="center",n==HEADER_WIDTH&&(ctx_file.textAlign="left"),n==canvas_file.width&&(ctx_file.textAlign="right",n-=5),ctx_file.fillText(r,n,5),ctx_file.beginPath(),ctx_file.moveTo(n,17),ctx_file.lineTo(n,DEVICE_HEIGHT),ctx_file.stroke()}}function draw_track(e,t=!1){if(e.hasOwnProperty("data")){var a=e.ty,i=e.th,n=get_caselen(),r=get_cookie("fit")?parseInt(get_cookie("fit")):0;if(t&&(tw=r?100*n:canvas_file.width-HEADER_WIDTH),ctx_file.fillStyle="#181818",ctx_file.fillRect(HEADER_WIDTH-1,a,canvas_file.width-HEADER_WIDTH,i),ctx_file.beginPath(),ctx_file.lineWidth=1,"W"===e.ttype){var o=!0,l=parseInt(e.prev.length/tw/100);l<1&&(l=1);for(var r=parseInt((HEADER_WIDTH-tx)*e.prev.length/tw),s=r=r<0?0:r,f=e.prev.length;s<f;s+=l)if(0!=e.prev[s])if(!((d=tx+s*tw/e.prev.length)<=HEADER_WIDTH)){if(d>=canvas_file.width)break;var _=a+i*(255-e.prev[s])/254;o&&(o=!1,ctx_file.moveTo(d,_)),ctx_file.lineTo(d,_)}}else if("N"===e.ttype)for(var c in e.data){var d,m=e.data[c],u=parseFloat(m[0]);if(!((d=tx+u/n*tw)<=HEADER_WIDTH)){if(d>=canvas_file.width)break;m=parseFloat(m[1]);m<=e.mindisp||((_=a+i-((m=m>=e.maxdisp?e.maxdisp:m)-e.mindisp)*i/(e.maxdisp-e.mindisp))<a?_=a:a+i<_&&(_=a+i),ctx_file.moveTo(d,_),ctx_file.lineTo(d,a+i))}}ctx_file.strokeStyle=e.color,ctx_file.stroke(),ctx_file.lineWidth=.5,ctx_file.strokeStyle="#808080",ctx_file.beginPath(),ctx_file.moveTo(HEADER_WIDTH,a+i),ctx_file.lineTo(canvas_file.width,a+i),ctx_file.stroke()}}function init_canvas(){ctx_file.clearRect(0,0,canvas_file.width,canvas_file.height),ctx_file.fillStyle="#181818",ctx_file.fillRect(0,0,canvas_file.width,canvas_file.height),ctx_file.font="100 12px arial",ctx_file.textBaseline="middle",ctx_file.textAlign="left";var e,t=DEVICE_HEIGHT,a="";for(e in tracks){var i=tracks[e];dname=i.dname,dname!=a&&(ctx_file.fillStyle="#505050",ctx_file.fillRect(0,t,canvas_file.width,DEVICE_HEIGHT),ctx_file.fillStyle="#ffffff",ctx_file.fillText(dname,8,t+DEVICE_HEIGHT-7),t+=DEVICE_HEIGHT,a=dname),ctx_file.fillStyle="#464646",ctx_file.fillRect(0,t,HEADER_WIDTH,i.th),ctx_file.fillStyle=i.color,tname=i.tname,ctx_file.fillText(tname,8,t+20),ctx_file.textAlign="left",ctx_file.fillStyle="#808080",ctx_file.fillText("LOADING...",HEADER_WIDTH+10,t+DEVICE_HEIGHT-7),t+=i.th}}function sort_tracks(){var e,t,a=[];for(e in ordered_tracks={},ordered_dnames={},devs){var i=devs[e];if(i.dname){var n,r=i.dname;for(n in-1==(_=DEVICE_ORDERS.indexOf(r))?_="99"+r:_<10?_="0"+_+r:_+=r,ordered_dnames[_]=r,i.trks){var o=i.trks[n];o.dname=i.dname,ordered_tracks[_]||(ordered_tracks[_]={}),ordered_tracks[_][o.tname]=o}}}for(t in dname_order=Object.keys(ordered_dnames),dname_order.sort(),dname_order){r=dname_order[t];a.push(ordered_dnames[r])}tracks=[];var l,s=Object.keys(ordered_tracks).sort();for(l in s){var f,_=s[l],c=Object.keys(ordered_tracks[_]).sort();for(f in c){var d=c[f];tracks.push(ordered_tracks[_][d])}}var m,u=DEVICE_HEIGHT,p="";for(m in tracks)(r=tracks[m].dname)!==p&&(p=r,u+=DEVICE_HEIGHT),tracks[m].ty=u,"W"==tracks[m].ttype?tracks[m].th=40:tracks[m].th=24,u+=tracks[m].th;canvas_file.height=canvas_file.clientHeight=u}function preloader(a,i="LOADING...",n=0){return new Promise(t=>{setTimeout(function(){$("#moni_preview").hide(),$("#moni_control").hide(),$("#file_preview").show(),$("#fit_width").show(),$("#fit_100px").show(),$("#convert_view").attr("onclick","draw_moniview()").html("Monitor View"),canvas_file.width=canvas_file.clientWidth=canvas_file.style.width=parseInt(canvas_file.parentNode.parentNode.clientWidth),$("#btn_preview").css("display","none"),canvas_file.height=800,ctx_file.clearRect(0,0,canvas_file.width,canvas_file.height),ctx_file.fillStyle="#181818",ctx_file.fillRect(0,0,canvas_file.width,canvas_file.height),ctx_file.font="100 30px arial",ctx_file.fillStyle="#ffffff";var e=ctx_file.measureText(i);ctx_file.fillText(i,(canvas_file.width-e.width)/2,(canvas_file.height-50)/2),0<n&&(ctx_file.fillStyle="#595959",ctx_file.fillRect((canvas_file.width-300)/2,canvas_file.height/2,300,3),e=3*n,ctx_file.fillStyle="#ffffff",ctx_file.fillRect((canvas_file.width-300)/2,canvas_file.height/2,e,3)),$("#span_preview_caseid").html(a),$("#div_preview").css("display",""),t()},100)})}function get_ctx_height(){return canvas_file.clientHeight}function draw_all_tracks(e=!1){for(var t in draw_time(e),tracks)draw_track(tracks[t],e)}function fit(e){return is_zooming=!1,tx=HEADER_WIDTH,set_cookie("fit",e),draw_all_tracks(!0),!0}function onResizeWindowT(){canvas_file.width=canvas_file.clientWidth=canvas_file.style.width=parseInt(canvas_file.parentNode.parentNode.clientWidth),init_canvas(),draw_all_tracks(!is_zooming)}function get_fileid(){return file.name}function get_caselen(){return fileend-filestart}function convert_data(e){console.time("converting");var t,a=Math.ceil(get_caselen()/e),i={},n=0;for(t in tracks){var r=tracks[t];if("W"==r.ttype){var o=r.srate*e;o<1&&(o=1);for(var l=0,s=r.data.length;l<s;l+=o){var f=parseInt(l/r.srate/e+.1);if(a<=f)break;-9999!=r.data[f]&&(i[f]===undefined&&(i[f]={}),i[f][n]=r.data[f])}}else{if("N"!=r.ttype)continue;for(var _ in r.data){var c=r.data[_],d=c[0];d!==undefined&&((c=c[1])!==undefined&&""!==c&&(f=parseInt(d/e),i[f]===undefined&&(i[f]={}),i[f][n]=c))}}n++}console.timeEnd("converting"),$("#span_status").html("Generating File"),setTimeout(function(){print_data(i,a,e)},100)}function DownloadBuf(){this.BUFLEN=1e5,this.buf=new Uint8Array(this.BUFLEN),this.bufs=[this.buf],this.bufpos=0,this.print=function(e){let t=0;for(var a=e.length;t<a;)this.buf[this.bufpos++]=e.charCodeAt(t++),this.bufpos==this.BUFLEN&&(this.buf=new Uint8Array(this.BUFLEN),this.bufs.push(this.buf),this.bufpos=0)},this.download=function(e,t){this.buf.slice(0,this.bufpos);var a=new Blob(this.bufs,{type:t}),t=URL.createObjectURL(a),a=document.createElement("a");a.download=e,a.target="_blank",a.href=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),delete a}}function print_data(e,t,a){console.time("generating csv");var i=new DownloadBuf;i.print("time,");var n,r=0,o=[];for(n in tracks){var l=tracks[n];"W"!=l.ttype&&"N"!=l.ttype||(o.push(l.tname),r++)}i.print(o.join()+"\n");for(var s=0;s<t;s++){if(i.print(""+s*a),e[s]!==undefined)for(var f=0;f<r;f++)v=e[s][f],i.print(","),v!==undefined&&i.print(""+v);i.print("\n")}console.timeEnd("generating csv"),$("#span_status").html("Downloading"),setTimeout(function(){$("#span_status").html("")},1e3),i.download(get_fileid()+".csv","text/csv"),delete i}function download_data(){0!=tracks.length&&($("#span_status").html("Converting"),setTimeout(function(){convert_data(.01,!0)},100))}function justify_all_tracks(){for(var e in console.time("justify"),devs){var t,a=devs[e];for(t in a.trks)a.trks[t].justify_recs()}console.timeEnd("justify")}function draw_trackview(){$("#moni_preview").hide(),$("#moni_control").hide(),$("#file_preview").show(),$("#fit_width").show(),$("#fit_100px").show(),$("#convert_view").attr("onclick","draw_moniview()").html("Monitor View"),is_zooming=!1,sort_tracks(),init_canvas(),draw_all_tracks(!0),0<tracks.length&&($("#span_preview_caseid").html(get_fileid()),$("#div_preview").css("display",""),$("#btn_preview").css("display",""))}$("#file_preview").bind("mouseup",function(e){$("#file_preview").is(":visible")&&(e=e.originalEvent,dragy=dragx=-1)}),$("#file_preview").bind("mousedown",function(e){$("#file_preview").is(":visible")&&(e=e.originalEvent,dragx=e.x,dragy=e.y,dragty=canvas_file.parentNode.scrollTop,dragtx=tx)}),$("#file_preview").bind("mousewheel",function(e){var t;$("#file_preview").is(":visible")&&(is_zooming=!0,e=e.originalEvent,t=Math.sign(e.wheelDelta),e.altKey||e.x<HEADER_WIDTH||(1<=t?(tw*=1.5,tx=e.x-1.5*(e.x-tx)):t<1&&(tw/=1.5,tx=e.x-(e.x-tx)/1.5),init_canvas(),draw_time(),tracks.forEach(function(e){draw_track(e)}),e.preventDefault()))}),$("#file_preview").bind("mousemove",function(e){$("#file_preview").is(":visible")&&(e=e.originalEvent,-1!=dragx&&(canvas_file.parentNode.scrollTop=dragty+(dragy-e.y),offset=canvas_file.parentNode.scrollTop-35,tx=dragtx+(e.x-dragx),draw_time(),tracks.forEach(function(e){draw_track(e)})))}),$(document).ready(function(){window.addEventListener("resize",onResizeWindowT)});const PAR_WIDTH=160,PAR_HEIGHT=80;var filename,caselen,canvas_moni=document.getElementById("moni_preview"),ctx_moni=canvas_moni.getContext("2d"),canvas_width=800,fast_forward=1,montype_groupids={},montype_trks={},groupid_trks={},dtplayer=0,isPaused=!0,isSliding=!1,groups=[{fgColor:"#00FF00",wav:"ECG_WAV",paramLayout:"TWO",param:["ECG_HR","ECG_PVC"],name:"ECG"},{fgColor:"#FF0000",wav:"IABP_WAV",paramLayout:"BP",param:["IABP_SBP","IABP_DBP","IABP_MBP"],name:"ART"},{fgColor:"#82CEFC",wav:"PLETH_WAV",paramLayout:"TWO",param:["PLETH_SPO2","PLETH_HR"],name:"PLETH"},{fgColor:"#FAA804",wav:"CVP_WAV",paramLayout:"ONE",param:["CVP_CVP"],name:"CVP"},{fgColor:"#DAA2DC",wav:"EEG_WAV",paramLayout:"TWO",param:["EEG_BIS","EEG_SEF"],name:"EEG"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT_CONC","AGENT_NAME"],name:"AGENT"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT1_CONC","AGENT1_NAME"],name:"AGENT1"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT2_CONC","AGENT2_NAME"],name:"AGENT2"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT3_CONC","AGENT3_NAME"],name:"AGENT3"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT4_CONC","AGENT4_NAME"],name:"AGENT4"},{fgColor:"#FAA804",paramLayout:"TWO",param:["AGENT5_CONC","AGENT5_NAME"],name:"AGENT5"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG_CE","DRUG_NAME"],name:"DRUG"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG1_CE","DRUG1_NAME"],name:"DRUG1"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG2_CE","DRUG2_NAME"],name:"DRUG2"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG3_CE","DRUG3_NAME"],name:"DRUG3"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG4_CE","DRUG4_NAME"],name:"DRUG4"},{fgColor:"#9ACE34",paramLayout:"TWO",param:["DRUG5_CE","DRUG5_NAME"],name:"DRUG5"},{fgColor:"#FFFF00",wav:"RESP_WAV",paramLayout:"ONE",param:["RESP_RR"],name:"RESP"},{fgColor:"#FFFF00",wav:"CO2_WAV",paramLayout:"TWO",param:["CO2_CONC","CO2_RR"],name:"CO2"},{fgColor:"#FFFFFF",paramLayout:"VNT",name:"VNT",param:["TV","RESP_RR","PIP","PEEP"]},{fgColor:"#F08080",paramLayout:"VNT",name:"NMT",param:["TOF_RATIO","TOF_CNT","PTC_CNT"]},{fgColor:"#FFFFFF",paramLayout:"BP",param:["NIBP_SBP","NIBP_DBP","NIBP_MBP"],name:"NIBP"},{fgColor:"#DAA2DC",wav:"EEGL_WAV",paramLayout:"TWO",param:["PSI","EEG_SEFL","EEG_SEFR"],name:"MASIMO"},{fgColor:"#FF0000",paramLayout:"TWO",param:["SPHB","PVI"]},{fgColor:"#FFC0CB",paramLayout:"TWO",param:["CO","SVV"],name:"CARTIC"},{fgColor:"#FFFFFF",paramLayout:"LR",param:["STO2_L","STO2_R"],name:"STO2"},{fgColor:"#828284",paramLayout:"TWO",param:["FLUID_RATE","FLUID_TOTAL"],name:"FLUID"},{fgColor:"#D2B48C",paramLayout:"ONE",param:["BT"]},{fgColor:"#FF0000",wav:"PAP_WAV",paramLayout:"BP",param:["PAP_SBP","PAP_DBP","PAP_MBP"],name:"PAP"},{fgColor:"#FF0000",wav:"FEM_WAV",paramLayout:"BP",param:["FEM_SBP","FEM_DBP","FEM_MBP"],name:"FEM"},{fgColor:"#00FF00",wav:"SKNA_WAV",paramLayout:"ONE",param:["ASKNA"],name:"SKNA"},{fgColor:"#FFFFFF",wav:"ICP_WAV",paramLayout:"TWO",param:["ICP","CPP"]},{fgColor:"#FF7F51",paramLayout:"TWO",param:["ANIM","ANII"]},{fgColor:"#99d9ea",paramLayout:"TWO",param:["FILT1_1","FILT1_2"]},{fgColor:"#C8BFE7",paramLayout:"TWO",param:["FILT2_1","FILT2_2"]},{fgColor:"#EFE4B0",paramLayout:"TWO",param:["FILT3_1","FILT3_2"]},{fgColor:"#FFAEC9",paramLayout:"TWO",param:["FILT4_1","FILT4_2"]}],paramLayouts={ONE:[{name:{baseline:"top",x:5,y:5},value:{fontsize:40,align:"right",x:PAR_WIDTH-5,y:PAR_HEIGHT-10}}],TWO:[{name:{baseline:"top",x:5,y:5},value:{fontsize:40,align:"right",x:PAR_WIDTH-5,y:42}},{name:{baseline:"bottom",x:5,y:PAR_HEIGHT-4},value:{fontsize:24,align:"right",x:PAR_WIDTH-5,y:PAR_HEIGHT-8}}],LR:[{name:{baseline:"top",x:5,y:5},value:{fontsize:40,align:"left",x:5,y:PAR_HEIGHT-10}},{name:{align:"right",baseline:"top",x:PAR_WIDTH-3,y:4},value:{fontsize:40,align:"right",x:PAR_WIDTH-5,y:PAR_HEIGHT-10}}],BP:[{name:{baseline:"top",x:5,y:5},value:{fontsize:38,align:"right",x:PAR_WIDTH-5,y:37}},{value:{fontsize:38,align:"right",x:PAR_WIDTH-5,y:PAR_HEIGHT-8}}],VNT:[{name:{baseline:"top",x:5,y:5},value:{fontsize:38,align:"right",x:PAR_WIDTH-45,y:37}},{value:{fontsize:30,align:"right",x:PAR_WIDTH-5,y:37}},{value:{fontsize:24,align:"right",x:PAR_WIDTH-5,y:PAR_HEIGHT-8}}]};function format_time(e){var t=e%60,a=Math.floor(e/60)%60;return[Math.floor(e/3600)%24,a,t].map(e=>e<10?"0"+e:e).filter((e,t)=>"00"!==e||0<t).join(":")}function get_bedname(e){return e.substr(0,e.length-20)}function get_datetime(e){var t=dateFormat(new Date,"yyyy").substr(0,2)+e.substr(e.length-19,2);t+="/"+e.substr(e.length-17,2),t+="/"+e.substr(e.length-15,2);var a=e.substr(e.length-14,2);return a+=":"+e.substr(e.length-12,2),t+" "+(a+=":"+e.subtr(e.length-10,2))}function get_playtime(){var e=new Date(1e3*(filestart+dtplayer));return("0"+e.getHours()).substr(-2)+":"+("0"+e.getMinutes()).substr(-2)+":"+("0"+e.getSeconds()).substr(-2)}function formatValue(e,t){return"S"===t?4<e.length?e.slice(0,4):e:("str"==typeof e&&(e=parseFloat(e)),100<=Math.abs(e)||e-Math.floor(e)<.05?e.toFixed(0):e.toFixed(1))}function roundedRect(e,t,a,i,n,r=0){e.beginPath(),e.moveTo(t,a+r),e.lineTo(t,a+n-r),e.arcTo(t,a+n,t+r,a+n,r),e.lineTo(t+i-r,a+n),e.arcTo(t+i,a+n,t+i,a+n-r,r),e.lineTo(t+i,a+r),e.arcTo(t+i,a,t+i-r,a,r),e.lineTo(t+r,a),e.arcTo(t,a,t,a+r,r)}function montype_group(){for(var e in groups){var t,a=groups[e];for(t in a.param){var i=a.param[t];montype_groupids[i]=e}a.wav&&(montype_groupids[a.wav]=e)}for(var n in devs){var r=devs[n];if(r.dname)for(var o in r.trks){var l=r.trks[o];montype_trks[l.montype]||(montype_trks[l.montype]=l),(e=montype_groupids[l.montype])&&(groupid_trks[e]||(groupid_trks[e]=[]),groupid_trks[e].push(l))}}}function draw_title(e){ctx_moni.font="40px arial",ctx_moni.fillStyle="#ffffff",ctx_moni.textAlign="left",ctx_moni.textBaseline="alphabetic";var t=get_bedname(file.name);ctx_moni.fillText(t,e+4,45);var a,i=e+ctx_moni.measureText(t).width+22,t=get_playtime();for(a in ctx_moni.font="bold 24px arial",ctx_moni.fillStyle="#FFFFFF",ctx_moni.textAlign="left",ctx_moni.textBaseline="alphabetic",ctx_moni.fillText(t,(e+canvas_width)/2-50,29),ctx_moni.font="15px arial",ctx_moni.textAlign="left",ctx_moni.textBaseline="alphabetic",devs){var n=devs[a];n.dname&&(ctx_moni.fillStyle="#348EC7",roundedRect(ctx_moni,i,36,12,12,3),ctx_moni.fill(),i+=17,ctx_moni.fillStyle="#FFFFFF",ctx_moni.fillText(n.dname.substr(0,7),i,48),i+=ctx_moni.measureText(n.dname.substr(0,7)).width+13)}}function draw_wave(n,r,o,l,s){if(n&&n.srate&&n.prev&&n.prev.length){ctx_moni.beginPath();let e=r,t=0,a=!0;var f=parseInt(dtplayer*n.srate),_=n.srate/100;let i=0;for(var c=f;c<f+(r+l)*_&&c<n.prev.length;c++,i+=1/_){var d=n.prev[c];if(0!=d){if(i>r+l)break;t=o+s*(255-d)/254,t<o&&(t=o),t>o+s&&(t=o+s),a?(i<r+10?(ctx_moni.moveTo(r,t),ctx_moni.lineTo(i,t)):ctx_moni.moveTo(i,t),a=!1):i-e>r+10?(ctx_moni.stroke(),ctx_moni.beginPath(),ctx_moni.moveTo(i,t)):ctx_moni.lineTo(i,t),e=i}}!a&&i>r+l-10&&ctx_moni.lineTo(r+l,t),ctx_moni.stroke(),a||i>r+l-4&&(ctx_moni.fillStyle="white",ctx_moni.fillRect(r+l-4,t-2,4,4))}}function draw_param(e,t,a,i){var n=!1;if(!e)return!1;if(!e.param)return!1;var r,o=paramLayouts[e.paramLayout],l=[];if(!o)return!1;for(r in e.param){var s=e.param[r],f=montype_trks[s];if(f&&f.data){t.add(f.tid);for(var _=null,c=0;c<f.data.length;c++){var d=f.data[c][0];if(dtplayer<d){0<c&&f.data[c-1][0]>dtplayer-300&&(_=f.data[c-1][1]);break}}_?(_=formatValue(_,f.ttype),l.push({name:f.tname,value:_}),n=!0):l.push({name:f.tname,value:""})}}if(!n)return!1;e.name&&"AGENT"===e.name.substring(0,5)&&1<l.length&&("DESF"===l[1].value.toUpperCase()?l[1].value="DES":"ISOF"===l[1].value.toUpperCase()?l[1].value="ISO":"ENFL"===l[1].value.toUpperCase()&&(l[1].value="ENF")),"BP"===e.paramLayout&&2<l.length?(l[0].name=e.name||"",l[0].value=(l[0].value?Math.round(l[0].value):" ")+(l[1].value?"/"+Math.round(l[1].value):" "),l[2].value=l[2].value?Math.round(l[2].value):"",l[1]=l[2],l.pop()):0<l.length&&!l[0].name&&(l[0].name=e.name||"");for(c=0;c<o.length&&c<l.length;c++){var m,u,p=o[c];p.value&&p&&(ctx_moni.font=p.value.fontsize+"px arial",ctx_moni.fillStyle=e.fgColor,"HPI"==l[0].name&&(ctx_moni.fillStyle="#00FFFF"),e.name&&"AGENT"===e.name.substring(0,5)&&1<l.length&&("DES"===l[1].value?ctx_moni.fillStyle="#2296E6":"ISO"===l[1].value?ctx_moni.fillStyle="#DDA0DD":"ENF"===l[1].value&&(ctx_moni.fillStyle="#FF0000")),ctx_moni.textAlign=p.value.align||"left",ctx_moni.textBaseline=p.value.baseline||"alphabetic",ctx_moni.fillText(l[c].value,a+p.value.x,i+p.value.y)),p.name&&(ctx_moni.font="14px arial",ctx_moni.fillStyle="white",ctx_moni.textAlign=p.name.align||"left",ctx_moni.textBaseline=p.name.baseline||"alphabetic",m=l[c].name,75<(u=ctx_moni.measureText(m).width)?(ctx_moni.save(),ctx_moni.scale(75/u,1),ctx_moni.fillText(m,(a+p.name.x)*u/75,i+p.name.y),ctx_moni.restore()):ctx_moni.fillText(m,a+p.name.x,i+p.name.y))}return ctx_moni.strokeStyle="#808080",ctx_moni.lineWidth=.5,roundedRect(ctx_moni,a,i,PAR_WIDTH,PAR_HEIGHT),ctx_moni.stroke(),!0}function draw(){canvas_width=window.innerWidth,ctx_moni.clearRect(0,0,canvas_moni.width,canvas_moni.height),ctx_moni.fillStyle="#181818",ctx_moni.fillRect(0,0,canvas_moni.width,canvas_moni.height),ctx_moni.save(),ctx_moni.scale(ctx_moni.width/canvas_width,ctx_moni.width/canvas_width);var t=0,a=60,i=canvas_width-PAR_WIDTH;draw_title(t);var e,n=new Set;for(f in groups)(c=groups[f]).wav&&(e=c.name,(d=montype_trks[c.wav])&&(d&&d.srate&&d.prev&&d.prev.length&&(n.add(d.tid),e=d.tname),draw_param(c,n,t+i,a),ctx_moni.lineWidth=2.5,ctx_moni.strokeStyle=c.fgColor,draw_wave(d,t,a,i,PAR_HEIGHT),ctx_moni.lineWidth=.5,ctx_moni.strokeStyle="#808080",ctx_moni.beginPath(),ctx_moni.moveTo(t,a+PAR_HEIGHT),ctx_moni.lineTo(t+i,a+PAR_HEIGHT),ctx_moni.stroke(),ctx_moni.font="14px Arial",ctx_moni.fillStyle="white",ctx_moni.textAlign="left",ctx_moni.textBaseline="top",ctx_moni.fillText(e,t+3,a+4),a+=PAR_HEIGHT));if(null!=evt_id){draw_param(null,null,i,a);var r=0;ctx_moni.font="14px arial",ctx_moni.textAlign="left",ctx_moni.textBaseline="alphabetic",evts=devs[tid2did[evt_id]].trks[evt_id].data;for(let e=0;e<evts.length;e++){var o=evts[e],l=o[0],s=o[1];if(ctx_moni.fillStyle="#4EB8C9",dtplayer<l)break;o=new Date(1e3*(l+filestart)),l=o.getHours(),o=("0"+o.getMinutes()).substr(-2);ctx_moni.fillText(l+":"+o,t+i+3,a+20+20*r),ctx_moni.fillStyle="white",ctx_moni.fillText(s,t+i+45,a+20+20*r),r+=1}}var f,_=!(t=0);for(f in groups){var c=groups[f],d=montype_trks[c.wav];if(!(d&&d.prev&&d.prev.length)&&(draw_param(c,n,t,a)&&(t+=PAR_WIDTH)>canvas_width-2*PAR_WIDTH)){if(t=0,a+=PAR_HEIGHT,!_)break;_=!1}}ctx_moni.restore()}var last_render=0;function redraw(){var e;$("#moni_preview").is(":visible")&&(update_frame(redraw),30<(e=Date.now())-last_render&&(last_render=e,!isPaused&&!isSliding&&dtplayer<caselen&&(dtplayer+=fast_forward/30,$("#moni_slider").val(dtplayer)),$("#casetime").html(format_time(Math.floor(dtplayer))+" / "+format_time(Math.floor(caselen))),draw()))}var update_frame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)};function onResizeWindow(){canvas_moni.width=canvas_moni.clientWidth=canvas_moni.style.width=parseInt(canvas_moni.parentNode.parentNode.clientWidth),canvas_moni.height=window.innerHeight-28,canvas_width=canvas_moni.width}function pause_resume(){(isPaused=!isPaused)?($("#moni_pause").hide(),$("#moni_resume").show()):($("#moni_resume").hide(),$("#moni_pause").show())}function rewind(e=null){e=e||(canvas_width-PAR_WIDTH)/100,(dtplayer-=e)<0&&(dtplayer=0)}function proceed(e=null){e=e||(canvas_width-PAR_WIDTH)/100,caselen<(dtplayer+=e)&&(dtplayer=caselen-(canvas_width-PAR_WIDTH)/100)}function slide_to(e){dtplayer=parseInt(e),isSliding=!1}function slide_on(e){$("#casetime").html(format_time(Math.floor(e))+" / "+format_time(Math.floor(caselen))),isSliding=!0}function set_playspeed(e){fast_forward=parseInt(e)}function draw_moniview(){fast_forward=1,montype_groupids={},montype_trks={},groupid_trks={},isPaused=!(dtplayer=0),caselen=get_caselen(),$("#file_preview").hide(),$("#moni_preview").show(),$("#moni_control").show(),$("#fit_width").hide(),$("#fit_100px").hide(),$("#convert_view").attr("onclick","draw_trackview()").html("Track View"),$("#moni_slider").attr("max",caselen).attr("min",0).val(0),montype_group(),onResizeWindow(),update_frame(redraw)}function set_cookie(e,t,a=30){var i,n="";a&&((i=new Date).setTime(i.getTime()+24*a*60*60*1e3),n="; expires="+i.toUTCString()),document.cookie=e+"="+(t||"")+n+"; path=/"}function get_cookie(e){for(var t=e+"=",a=document.cookie.split(";"),i=0;i<a.length;i++){for(var n=a[i];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return null}function erase_cookie(e){document.cookie=e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}$(document).ready(function(){window.addEventListener("resize",onResizeWindow),canvas_moni.addEventListener("click",function(e){$("#moni_preview").is(":visible")&&pause_resume()}),document.addEventListener("keydown",function(e){$("#moni_preview").is(":visible")&&(37==e.keyCode&&(e.stopPropagation(),e.preventDefault(),rewind()),39==e.keyCode&&(e.stopPropagation(),e.preventDefault(),proceed()),32==e.keyCode&&(e.stopPropagation(),e.preventDefault(),pause_resume()))})});