const path=require("path"),fs=require("graceful-fs"),zlib=require("zlib"),montypes={1:"ECG_WAV",2:"ECG_HR",3:"ECG_PVC",4:"IABP_WAV",5:"IABP_SBP",6:"IABP_DBP",7:"IABP_MBP",8:"PLETH_WAV",9:"PLETH_HR",10:"PLETH_SPO2",11:"RESP_WAV",12:"RESP_RR",13:"CO2_WAV",14:"CO2_RR",15:"CO2_CONC",16:"NIBP_SBP",17:"NIBP_DBP",18:"NIBP_MBP",19:"BT",20:"CVP_WAV",21:"CVP_CVP",22:"EEG_BIS",23:"TV",24:"MV",25:"PIP",26:"AGENT1_NAME",27:"AGENT1_CONC",28:"AGENT2_NAME",29:"AGENT2_CONC",30:"DRUG1_NAME",31:"DRUG1_CE",32:"DRUG2_NAME",33:"DRUG2_CE",34:"CO",36:"EEG_SEF",38:"PEEP",39:"ECG_ST",40:"AGENT3_NAME",41:"AGENT3_CONC",42:"STO2_L",43:"STO2_R",44:"EEG_WAV",45:"FLUID_RATE",46:"FLUID_TOTAL",47:"SVV",49:"DRUG3_NAME",50:"DRUG3_CE",52:"FILT1_1",53:"FILT1_2",54:"FILT2_1",55:"FILT2_2",56:"FILT3_1",57:"FILT3_2",58:"FILT4_1",59:"FILT4_2",60:"FILT5_1",61:"FILT5_2",62:"FILT6_1",63:"FILT6_2",64:"FILT7_1",65:"FILT7_2",66:"FILT8_1",67:"FILT8_2",70:"PSI",71:"PVI",72:"SPHB",73:"ORI",75:"ASKNA",76:"PAP_SBP",77:"PAP_MBP",78:"PAP_DBP",79:"FEM_SBP",80:"FEM_MBP",81:"FEM_DBP",82:"EEG_SEFL",83:"EEG_SEFR",84:"EEG_SR",85:"TOF_RATIO",86:"TOF_CNT",87:"SKNA_WAV",88:"ICP",89:"CPP",90:"ICP_WAV",91:"PAP_WAV",92:"FEM_WAV",93:"ALARM_LEVEL",95:"EEGL_WAV",96:"EEGR_WAV",97:"ANII",98:"ANIM",99:"PTC_CNT"};function VitalFile(t,e,i=[],r=!1,s=[]){this.devs={0:{}},this.trks={},this.dtstart=0,this.dtend=0,this.dgmt=0,".vital"==path.extname(e)&&this.load_vital(t,e,i,r,s)}function buf2str(t,e){var i=t.readUIntLE(e,4);return e+=4,[t.toString("utf8",e,e+i),e+=i]}function parse_fmt(t){return 1==t?["f",4]:2==t?["d",8]:3==t?["b",1]:4==t?["B",1]:5==t?["h",2]:6==t?["H",2]:7==t?["l",4]:8==t?["L",4]:["",0]}VitalFile.prototype.load_vital=function(e,i,t,V,r){var s=fs.createReadStream(i),n=zlib.createGunzip(),g=!1,S=null,C=s.pipe(n);return new Promise(t=>{C.on("data",t=>{var e=0;if(!g){g=!0;var i=t.toString("utf8",e,e+4);if(e+=4,"VITA"!=i)throw new Error("invalid vital file");e+=4,e+=2,this.dgmt=t.readIntLE(e,2),e+=2,e+=4;for(var r=0;r<4;r++)t.readUIntLE(e,1),e+=1,3!=r&&0}for(S&&(i=S.length+t.length,t=Buffer.concat([S,t],i));e+5<t.length;){var s=t.readIntLE(e,1),n=t.readUIntLE(e+1,4);if(0!=s&&9!=s&&1!=s&&6!=s&&C.close(),S=t.slice(e,e+5+n),t.length<e+5+n)break;var a=e+=5,d=5;if(9==s){var l=S.readUIntLE(d,4);d+=4,A="",[h,d]=buf2str(S,d),[p,d]=buf2str(S,d),[A,d]=buf2str(S,d),this.devs[l]={name:p,type:h,port:A}}else if(0==s){var o,_,E,f,h,c=o="",I=F=l=0,L=S.readUIntLE(d,2);d+=2;var u=S.readIntLE(d,1);d+=1;var p=S.readIntLE(d,1);d+=1,[h,d]=buf2str(S,d),[o,d]=buf2str(S,d),E=S.readFloatLE(d),d+=4,f=S.readFloatLE(d),d+=4,P=S.readUIntLE(d,4),d+=4,_=S.readFloatLE(d),d+=4,I=S.readDoubleLE(d),d+=8,F=S.readDoubleLE(d),d+=8,c=S.readIntLE(d,1),d+=1,l=S.readUIntLE(d,4),d+=4;var A="",A=l&&l in this.devs?this.devs[l].name+"/"+h:h;this.trks[L]={name:h,dtname:A,type:u,fmt:p,unit:o,srate:_,mindisp:E,maxdisp:f,col:P,montype:c,gain:I,offset:F,did:l,recs:[]}}else if(1==s){S.readUIntLE(d,2);d+=2;var P=S.readDoubleLE(d);d+=8;L=S.readUIntLE(d,2);if(d+=2,(0==this.dtstart||0<P&&P<this.dtstart)&&(this.dtstart=P),P>this.dtend&&(this.dtend=P),V){S=null,e=a+n;continue}var F,T,v,m,c=this.trks[L],I=4;1==c.type?([v,I]=parse_fmt(c.fmt),F=S.readUIntLE(d,4),d+=4,P+F/this.trks[L].srate>this.dtend&&(this.dtend=P+F/this.trks[L].srate),"f"==v?T=new Float32Array(S.slice(d,d+F*I)):"d"==v?T=new Float64Array(S.slice(d,d+F*I)):"b"==v?T=new Int8Array(S.slice(d,d+F*I)):"B"==v?T=new Uint8Array(S.slice(d,d+F*I)):"h"==v?T=new Int16Array(S.slice(d,d+F*I)):"H"==v?T=new Uint16Array(S.slice(d,d+F*I)):"l"==v?T=new Int32Array(S.slice(d,d+F*I)):"L"==v&&(T=new Uint32Array(S.slice(d,d+F*I))),c.recs.push({dt:P,val:T})):2==c.type?([v,I]=parse_fmt(c.fmt),"f"==v?(m=S.readFloatLE(d),d+=I):"d"==v?(m=S.readDoubleLE(d),d+=I):"b"==v||"h"==v||"l"==v?(m=S.readIntLE(d,I),d+=I):"B"!=v&&"H"!=v&&"L"!=v||(m=S.readUIntLE(d,I),d+=I),c.recs.push({dt:P,val:m})):5==c.type&&(d+=4,[y,d]=buf2str(S,d),c.recs.push({dt:P,val:y}))}else if(6==s){if(V){S=null,e=a+n;continue}var y=S.readIntLE(d,1);d+=1,6==y?(s=this.find_track("/EVENT"))&&(s.recs=[],console.log(this.trks[s.id])):5==y&&(y=S.readUIntLE(d,2),d+=2,this.trkorder=new Uint16Array(S.slice(d,d+2*y)))}e=a+n}e+5>=t.length&&(S=t.slice(e))}),C.on("end",()=>{console.log(this.toString()),this.toRedis(e,i),t()}),C.on("close",()=>{console.log(this.toString()),this.toRedis(e,i),t()}),C.on("error",t=>{console.log(t),C.close()})})},VitalFile.prototype.get_color=function(t){if(t in this.trks)return"#"+("0"+Number(this.trks[t].col).toString(16)).slice(3).toUpperCase();throw new Error(t+" does not exist in track list")},VitalFile.prototype.get_montype=function(t){if(t in this.trks){var e=this.trks[t].montype;return e in montypes?montypes[e]:""}throw new Error(t+" does not exist in track list")},VitalFile.prototype.get_track_names=function(){var t,e=[];for(t in this.trks){var i=this.trks[t];i.dtname&&e.push(i.dtname)}return e},VitalFile.prototype.find_track=function(t){var e,i="",r=t;for(e in-1<t.indexOf("/")&&([i,r]=t.split("/")),this.trks){var s=this.trks[e];if(s.name==r){if(did=s.did,0==did||""==i)return s;if(did in this.devs){var n=this.devs[did];if("name"in n&&i==n.name)return s}}}return null},VitalFile.prototype.toString=function(){var t={};return t.dtstart=this.dtstart,t.dtend=this.dtend,t.dgmt=this.dtmt,t.devices=this.devs,t.tracklist=this.get_track_names(),JSON.stringify(t)},VitalFile.prototype.toRedis=function(t,e){var i=path.parse(e).name,r=i.substr(0,i.length-14),s=i.substr(i.length-13,6),n=fs.statSync(e),e=Math.floor(n.mtimeMs/1e3),n=n.size;console.log(i,n),t.sadd("stats:file:bed",r),t.hincrby("stats:filecnt",s,1),t.hincrby("stats:filecnt:"+r,s,1),t.hincrby("stats:filesize",s,n),t.hincrby("stats:filesize:"+r,s,n),t.zadd("api:filelist:dtupload",e,i),t.zadd("api:filelist:dtstart",this.dtstart,i),t.zadd("api:filelist:dtend",this.dtend,i),t.set("api:filelist:fileinfo:"+i,JSON.stringify({dtstart:this.dtstart,dtend:this.dtend,dtupload:e,filesize:n}));n=JSON.stringify(this.get_track_names());t.set("api:tracklist:"+i,n)},module.exports=VitalFile;