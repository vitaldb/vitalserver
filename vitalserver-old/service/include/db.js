const crypto=require("crypto"),redis=require("redis"),client=redis.createClient(6379,"0.0.0.0"),asyncRedis=require("async-redis"),fs=require("fs"),asyncClient=asyncRedis.createClient(6379,"0.0.0.0"),config=require("./config.js"),request=require("request");async function get_config(){var e=new Object;return e.websocket_ip=await asyncClient.get("websocket:ip"),e.websocket_port=await asyncClient.get("websocket:port"),e.filter_ip=await asyncClient.get("filter:ip"),e.filter_port=await asyncClient.get("filter:port"),e.storage=await asyncClient.get("storage"),e.vr_version=await asyncClient.get("vr_version"),e}function set_config(e){var s=!1;try{null!=e.websocketIp&&client.set("websocket:ip",e.websocketIp),null!=e.websocketPort&&client.set("websocket:port",e.websocketPort),null!=e.filterIp&&client.set("filter:ip",e.filterIp),null!=e.filterPort&&client.set("filter:port",e.filterPort),null!=e.storage&&client.set("storage",e.storage),s=!0}catch(e){console.log("set_config ERROR",e)}return s}async function set_vr(e,s){var t=new Object;try{client.set("vr_version",e.version),t.result=!0}catch(e){t.result=!1,t.msg="set_vr ERROR",console.log("set_vr ERROR",e)}return t}async function set_user(e,s){var t,r=new Object;try{if("add"==s)await asyncClient.sismember("users",e.userId)?(r.result=!1,r.msg="User ID is duplicated."):((t=new Object).id=e.userId,t.password=e.userId,t.name=e.userName,t.email=e.userEmail,t.admin_yn="N",client.sadd("users",e.userId),client.set("users:"+e.userId,JSON.stringify(t)),r.result=!0,r.msg="success");else if("del"==s){for(var a in e){var n,i=e[a].id,l=await asyncClient.smembers("users:share:"+i);for(n in l){var o=l[n];client.srem("beds:share:"+o,i),client.del("users:mode:"+i+":"+o),client.del("users:group:"+i+":"+o)}client.del("users:"+i),client.del("users:share:"+i),client.srem("users",i)}r.result=!0,r.msg="success"}else(t=JSON.parse(await asyncClient.get("users:"+e.userId)))?t.password==e.cur_password?(t.name=e.userName,t.email=e.userEmail,client.set("users:"+e.userId,JSON.stringify(t)),r.result=!0,r.msg="Your information has been changed."):(r.result=!1,r.msg="Password is wrong."):(r.result=!1,r.msg="Error")}catch(e){r.result=!1,r.msg="Error",console.log("set_user ERROR",e)}return r}async function set_hl7(e,s){var t=new Object;try{if("add"==s)client.sadd("hl7",JSON.stringify(e)),t.result=!0,t.msg="success";else if("conf"==s)e.host&&client.set("hl7:ip",e.host),e.port&&client.set("hl7:port",e.port),t.result=!0,t.msg="success";else{for(var r in e)client.srem("hl7",JSON.stringify(e[r]));t.result=!0,t.msg="success"}}catch(e){t.result=!1,t.msg="Error",console.log("set_hl7 ERROR",e)}return t}async function get_hl7_host(){return await asyncClient.get("hl7:ip")||""}async function get_hl7_port(){return await asyncClient.get("hl7:port")||""}async function set_password(e){var s=new Object;try{var t=JSON.parse(await asyncClient.get("users:"+e.id));t?t.password==e.mb_password?(t.password=e.new_password,client.set("users:"+e.id,JSON.stringify(t)),s.result=!0,s.msg="Your Password has been changed."):(s.result=!1,s.msg="Password is wrong."):(s.result=!1,s.msg="Error")}catch(e){s.result=!1,s.msg="Error",console.log("set_password ERROR",e)}return s}async function get_websocket_host(){var e=await asyncClient.get("websocket:ip"),s=await asyncClient.get("websocket:port");return s&&(e+=":"+s),e}async function get_websocket_port(){return await asyncClient.get("websocket:port")||"80"}async function get_filter_host(){var e=await asyncClient.get("filter:ip"),s=await asyncClient.get("filter:port");return s&&(e+=":"+s),e}async function get_filter_list(){var a=__dirname+"/../static/filters.json";if(fs.existsSync(a))return JSON.parse(fs.readFileSync(a));var e={uri:"http://"+await get_filter_host(),gzip:!0};return new Promise(function(r){request(e,function(e,s,t){e||200!=s.statusCode||(fs.writeFileSync(a,t),r(JSON.parse(t)))})}).then(e=>{throw new Error("Could not get filter list."+e)}).catch(error)}async function get_storage(){return await asyncClient.get("storage")||config.get_file_folder()}async function get_admin_id(){var e,s=await asyncClient.smembers("users"),t="";for(e in s){var r=s[e];"Y"==JSON.parse(await asyncClient.get("users:"+r)).admin_yn&&(t=r)}return t}async function is_admin(e){var s=await asyncClient.get("users:"+e);if(s){e=!1;return e="Y"==JSON.parse(s).admin_yn?!0:e}return!1}async function login(e,s){var t=JSON.parse(await asyncClient.get("users:"+e));return t?s==t.password?(t.result=!0,t.msg=e+" : success"):(t.result=!1,t.msg=e+" : wrong password"):((t=new Object).result=!1,t.msg=e+" : no user"),t}async function api_login(e,s){var t={},r=JSON.parse(await asyncClient.get("users:"+e));return r?s==r.password?((r=await asyncClient.get("token:"+e))||(r=Math.random().toString(36).slice(2,11),client.set("token:"+e,r,"EX",1800),client.set("userid:"+r,e,"EX",1800)),t.res=!0,t.access_token=r):(t.res=!1,t.error=e+" : wrong password"):(t.res=!1,t.error=e+" : user not found"),t}async function check_access_token(e){var s=await asyncClient.get("userid:"+e);return s&&(client.set("token:"+s,e,"EX",1800),client.set("userid:"+e,s,"EX",1800)),s}function ut2d(e){var s=new Date(1e3*e),t=s.getMonth()+1,r=s.getDate(),a=s.getHours(),n=s.getMinutes(),e=s.getSeconds();return s.getFullYear()+"-"+(9<t?t:"0"+t)+"-"+(9<r?r:"0"+r)+" "+(9<a?a:"0"+a)+":"+(9<n?n:"0"+n)+":"+(9<e?e:"0"+e)}async function api_tracklist(e){console.log((new Date).toString());var s={},t=await check_access_token(e.access_token);if(t){var r,a,n=e.bedname||null,i=e.dtstart||null,l=e.dtend||null,o=e.dtuploadstart||null,e=e.dtuploadend||null,c=await get_bednames(t,[2,4]);if(s.res=!0,s.data=[],o||e){o?(r=new Date(o),isNaN(r)||(o=Math.floor(r.getTime()/1e3))):o=0,e?(a=new Date(e),isNaN(a)||(e=Math.floor(a.getTime()/1e3))):e="+inf";var u=[];for(w in f=await asyncClient.zrangebyscore("api:filelist:dtupload",o,e)){var d=(g=f[w]).slice(0,-14);c.includes(d)&&(n&&g.indexOf(n)<0||u.push("api:tracklist:"+g))}if(0<u.length)for(w in m=await asyncClient.mget(u)){var g=u[w].split(":").pop(),_=JSON.parse(m[w]);s.data.push({filename:g+".vital",trks:_})}}else{i?(i.length<=10&&(i+=" 00:00:00"),r=new Date(i),isNaN(r)||(i=Math.floor(r.getTime()/1e3)-60)):i=0,l?(l.length<=10&&(l+=" 00:00:00"),a=new Date(l),isNaN(a)||(l=Math.floor(a.getTime()/1e3)+60)):l="+inf";var f,m,w,u=[];for(w in f=await asyncClient.zrangebyscore("api:filelist:dtstart",i,l)){d=(g=f[w]).slice(0,-14);c.includes(d)&&(n&&g.indexOf(n)<0||u.push("api:tracklist:"+g))}if(0<u.length)for(w in m=await asyncClient.mget(u)){g=u[w].split(":").pop(),_=JSON.parse(m[w]);s.data.push({filename:g+".vital",trks:_})}}}else s.res=!1,s.error="Invalid access token";return s}function get_bedname_from_file(e,s=!1){return s?e.slice(0,-20):e.slice(0,-14)}async function icu_filelist(e,s){var t=Math.floor(new Date(s+" 00:00:00").getTime()/1e3)-60,s=86460+t,r=await asyncClient.zrangebyscore("api:filelist:dtstart",t,s),a=[],n=[],i=[],l=[],o={};for(g in r){var c=r[g];0==c.indexOf(e)&&(a.push(c),n.push("api:filelist:fileinfo:"+c),i.push("hid1:"+c),l.push("hid2:"+c))}if(0<a.length)for(var u=a.length,d=5e5,g=0;g<Math.ceil(u/d);g++){var _,f=await asyncClient.mget(n.slice(g*d,(g+1)*d)),m=await asyncClient.mget(i.slice(g*d,(g+1)*d)),w=await asyncClient.mget(l.slice(g*d,(g+1)*d));for(_ in f){var p=g*d+ +_,y=get_bedname_from_file(a[p]);void 0===o[y]&&(o[y]={});var b=JSON.parse(f[_]);b.bedname=y.slice(e.length),b.filename=a[p].slice(-6),b.duration=Math.round(b.dtend-b.dtstart),b.hid1=m[p]||null,b.hid2=w[p]||null;p=b.filename.slice(0,2);void 0===o[y][p]&&(o[y][p]=[]),o[y][p].push(b)}}return o}async function register_bed(e,s){var t;try{for(var r in t=await get_admin_id(),client.sadd("vrs",e),s)if(s[r].roomname){var a=crypto.createHash("sha1");a.update(t+"/"+s[r].roomname);var n=a.digest("hex"),a={};a.vrcode=e,a.bedname=s[r].roomname;var i,l=await asyncClient.smembers("vrs");for(i in l){var o=l[i];o!=e&&await asyncClient.sismember("vrs:"+o,n)&&client.srem("vrs:"+o,n)}client.sadd("vrs:"+e,n),client.sadd("beds",n),client.set("beds:"+n,JSON.stringify(a))}}catch(e){console.log("register_bed ERROR",e)}}async function get_bed_cnt(e=null){return null==e||"admin"==e?await asyncClient.scard("beds"):await asyncClient.scard("users:share:"+e)}async function get_share_info(e,s=[]){var t=new Object,r=new Array;if(await is_admin(e)){var a=await asyncClient.smembers("beds");for(n in a)(l={bedid:i=a[n],mode:"0"}).group=await asyncClient.get("users:group:"+e+":"+i),l.group||(l.group=""),(c=JSON.parse(await asyncClient.get("beds:"+i)))&&(l.vrcode=c.vrcode,l.bedname=c.bedname,r.push(l))}else{var n,i,l,o=await asyncClient.smembers("users:share:"+e);for(n in o){(l={bedid:i=o[n]}).mode=await asyncClient.get("users:mode:"+e+":"+i),l.group=await asyncClient.get("users:group:"+e+":"+i),l.group||(l.group="");var c=JSON.parse(await asyncClient.get("beds:"+i));if(c||console.log("Error: "+e+" "+i),c&&(l.vrcode=c.vrcode,l.bedname=c.bedname,0<s.length)){var u,d=!1;for(u in s){var g=s[u];(l.mode&g)==g&&(d=!0)}d&&r.push(l)}}}var _=await asyncClient.smembers("users:group:"+e);return t.rooms=r,t.groups=_.sort(),t}async function get_bednames(e,s=[]){if(e){var t=[];if(await is_admin(e)){var r=await get_storage(),a=fs.readdirSync(r);for(i in a){var n=a[i];-1<n.indexOf("recycle")||-1<n.indexOf("adt")||t.push(n)}}else{var i,l=await asyncClient.smembers("users:share:"+e);for(i in l){var o=l[i],c=await asyncClient.get("users:mode:"+e+":"+o);if(0<s.length){var u,d=!1;for(u in s){var g=s[u];(c&g)==g&&(d=!0)}o=JSON.parse(await asyncClient.get("beds:"+o));o&&d&&t.push(o.bedname)}}}return t=t.sort(function(e,s){return e.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})})}}async function get_bed_list(e){if(e){var s=new Object,t=new Array,r=new Array;if(await is_admin(e)){var a=await asyncClient.smembers("vrs");for(c in a){var n=a[c],i=await asyncClient.smembers("vrs:"+n);if(i.length<=0)r.push({vrcode:n});else for(var l in i){var o=i[l];(d=JSON.parse(await asyncClient.get("beds:"+o)))&&(d.bedid=o,d.group=await asyncClient.get("users:group:"+e+":"+o),d.group||(d.group=""),d.islinux=await asyncClient.get("islinux:"+d.bedname),d.islinux||(d.islinux=!1),t.push(d))}}}else{var c,u=await asyncClient.smembers("users:share:"+e);for(c in u){var d,o=u[c];(d=await asyncClient.get("beds:"+o))&&((d=JSON.parse(d)).bedid=o,d.mode=await asyncClient.get("users:mode:"+e+":"+o),d.group=await asyncClient.get("users:group:"+e+":"+o),d.group||(d.group=""),d.islinux=await asyncClient.get("islinux:"+d.bedname),d.islinux||(d.islinux=!1),t.push(d))}}s.vrs=t.sort(generateSortFn([{name:"group"},{name:"bedname"}])),s.unnamed=r;var g=await asyncClient.smembers("users:group:"+e);return s.groups=g.sort(),s}}async function get_user_list(){var e,s=await asyncClient.smembers("users"),t=new Array;for(e in s){var r=JSON.parse(await asyncClient.get("users:"+s[e]));t.push(r)}return t}async function del_bed(e){var s=e.vrcode,e=e.bedid;await asyncClient.srem("vrs:"+s,e),await asyncClient.srem("beds",e),await asyncClient.del("beds:"+e),await asyncClient.del("users:group:"+await get_admin_id()+":"+e),await asyncClient.scard("vrs:"+s)<=0&&(await asyncClient.srem("vrs",s),await asyncClient.del("vrs:"+s))}async function del_vr(e){e=e.vrcode;await asyncClient.srem("vrs",e),await asyncClient.del("vrs:"+e)}async function get_data(e){var s,t=JSON.parse(JSON.stringify(e.body));switch(t.job){case"get_myvrs":(s=await get_bed_list(e.session.userInfo.id)).viewers=new Object;break;case"get_sharedvrs":console.log(t.job),s=await get_sharedvrs(e.session.userInfo.id);break;case"get_viewers":s=await get_viewers(t);break;case"edit_permission":s=await edit_permission(e.session.userInfo.id,t);break;case"del_bed":s=await del_share_bed(e.session.userInfo.id,t);break;case"del_beds":s=await del_share_beds(e.session.userInfo.id,t);break;case"move_vrs":s=await move_vrs(e.session.userInfo.id,t);break;case"share":s=await share_beds(e.session.userInfo.id,t);break;case"add_group":s=await add_group(e.session.userInfo.id,t);break;case"edit_group":s=await edit_group(e.session.userInfo.id,t);break;case"del_group":s=await del_group(e.session.userInfo.id,t)}return s}async function get_files(e){var s,t=JSON.parse(JSON.stringify(e.body));if("list"===t.job){var r=[],a=await asyncClient.zrangebyscore("api:filelist:dtstart",t.sdate,"("+t.edate),n=[],i=[],l=await get_bednames(e.session.userInfo.id,[2,4]);for(c in a){var o=(g=a[c]).slice(0,-14);l.includes(o)&&(t.bedname&&g.indexOf(t.bedname)<0||t.selected_bed&&o!=t.selected_bed||(n.push("api:filelist:fileinfo:"+g),i.push("api:tracklist:"+g)))}if(0<n.length){var c,u=await asyncClient.mget(n),d=await asyncClient.mget(i);for(c in u){var g=n[c].split(":").pop(),_=JSON.parse(u[c]);_.filename=g,_.trks=JSON.parse(d[c]),r.push(_)}}s=r}return s}function generateSortFn(n){return function(e,s){for(var t=0;t<n.length;t++){var r=n[t],a=r.name,r=r.reverse,a=e[a].localeCompare(s[a],void 0,{numeric:!0,sensitivity:"base"});if(a<0)return r?1:-1;if(0<a)return r?-1:1}return 0}}module.exports={get_config:get_config,set_config:set_config,set_vr:set_vr,set_user:set_user,set_hl7:set_hl7,get_hl7_host:get_hl7_host,get_hl7_port:get_hl7_port,set_password:set_password,get_websocket_host:get_websocket_host,get_websocket_port:get_websocket_port,get_filter_host:get_filter_host,get_filter_list:get_filter_list,get_storage:get_storage,login:login,api_login:api_login,check_access_token:check_access_token,api_tracklist:api_tracklist,icu_filelist:icu_filelist,register_bed:register_bed,get_admin_id:get_admin_id,is_admin:is_admin,get_bed_cnt:get_bed_cnt,get_share_info:get_share_info,get_bed_list:get_bed_list,get_bednames:get_bednames,get_files:get_files,get_user_list:get_user_list,del_bed:del_bed,del_vr:del_vr,get_data:get_data,ut2d:ut2d};async function get_viewers(e){var s,t=new Array,r=e.bedid,a=await asyncClient.smembers("beds:share:"+r);for(s in a){var n={};n.viewerid=a[s],n.mode=await asyncClient.get("users:mode:"+n.viewerid+":"+r);var i=JSON.parse(await asyncClient.get("users:"+n.viewerid));n.name=i.name,t.push(n)}return t}async function get_sharedvrs(e){var s,t=new Object,r=await asyncClient.smembers("users:share:"+e),a=new Array;for(s in r){var n={bedid:r[s]},i=await asyncClient.get("beds:"+n.bedid);i&&(i=JSON.parse(i).bedname,n.bedname=i,n.mode=await asyncClient.get("users:mode:"+e+":"+n.bedid),n.group=await asyncClient.get("users:group:"+e+":"+n.bedid),null==n.group&&(n.group=""),n.islinux=await asyncClient.get("islinux:"+i),n.islinux||(n.islinux=!1),0<n.mode&&a.push(n))}var l=await asyncClient.smembers("users:group:"+e);return t.vrs=a.sort(generateSortFn([{name:"group"},{name:"bedname"}])),t.groups=l.sort(),t}async function edit_permission(e,s){var t=s.bedid,r=s.viewers,a=s.new_viewers;if(await is_admin(e)){for(var n in r){var i=r[n];if("del"==i.delete)client.srem("beds:share:"+t,n),client.srem("users:share:"+n,t),client.del("users:group:"+n+":"+t),client.del("users:mode:"+n+":"+t);else if("del-all"==i.delete){var l=await asyncClient.smembers("users:share:"+n);for(o in l)client.srem("beds:share:"+l[o],n),client.del("users:group:"+n+":"+l[o]),client.del("users:mode:"+n+":"+l[o]);client.del("users:share:"+n)}else 0<(u=i.permission.reduce((e,s)=>parseInt(e)+parseInt(s),0))&&(client.sadd("beds:share:"+t,n),client.sadd("users:share:"+n,t),client.set("users:mode:"+n+":"+t,u))}for(var o in a){var c,u,n="",d=a[o];for(c in s)c=="viewer_"+o&&(n=s[c]);await asyncClient.sismember("users",n)&&0<(u=d.permission.reduce((e,s)=>parseInt(e)+parseInt(s),0))&&(client.sadd("beds:share:"+t,n),client.sadd("users:share:"+n,t),client.set("users:mode:"+n+":"+t,u))}}return get_viewers(s)}async function del_share_bed(e,s){var t=new Object,s=s.bedid;return client.srem("beds:share:"+s,e),client.srem("users:share:"+e,s),client.del("users:group:"+e+":"+s),client.del("users:mode:"+e+":"+s),t.success=0,t}async function del_share_beds(e,s){var t,r=new Object,a=s.bedids.split(",");for(t in a)await del_share_bed(e,{bedid:a[t]});return r.success=0,r}async function move_vrs(e,s){var t,r=new Object,a=s.bedids.split(","),n=s.groupname;for(t in client.sadd("users:group:"+e,n),a){var i=a[t];client.set("users:group:"+e+":"+i,n)}return r.success=0,r}async function share_beds(e,s){var t,r=new Object,a=s.viewers.split(","),n=s.bedids.split(","),i=s.mode;for(t in a){var l=a[t];if(await asyncClient.sismember("users",l))for(var o in n){var c=n[o];client.sadd("beds:share:"+c,l),client.sadd("users:share:"+l,c),client.set("users:mode:"+l+":"+c,i)}}return r.msg="The following beds are shared to "+s.viewers+" : "+s.bednames+".",r}async function add_group(e,s){var t=new Object;return client.sadd("users:group:"+e,s.groupname),t.result="0",t}async function edit_group(e,s){var t,r,a=new Object;for(r in t=is_admin(e)?await asyncClient.smembers("beds"):await asyncClient.smembers("users:share:"+e)){var n="users:group:"+e+":"+t[r];await asyncClient.get(n)==s.groupname&&client.set(n,s.new_name)}return client.srem("users:group:"+e,s.groupname),client.sadd("users:group:"+e,s.new_name),a.result="0",a}async function del_group(e,s){var t,r,a=new Object;for(r in t=is_admin(e)?await asyncClient.smembers("beds"):await asyncClient.smembers("users:share:"+e)){var n="users:group:"+e+":"+t[r];await asyncClient.get(n)==s.groupname&&client.del(n)}return client.srem("users:group:"+e,s.groupname),a.result="0",a}